<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia con GeolocalizaciÃ³n</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-start: #0f172a;
            --bg-end: #1e293b;
            --card-bg: #1e293b;
            --card-border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, var(--bg-start), var(--bg-end)); min-height: 100vh; color: var(--text-primary); }
        .screen { display: none; min-height: 100vh; padding: 20px; }
        .screen.active { display: block; }
        .container { max-width: 1400px; margin: 0 auto; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: rgba(30,41,59,0.9); border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--card-border); flex-wrap: wrap; gap: 15px; }
        .navbar-brand { font-size: 1.4rem; font-weight: 700; }
        .navbar-user { display: flex; align-items: center; gap: 15px; }
        .user-name { font-weight: 600; }
        .user-role { font-size: 0.8rem; color: var(--text-muted); }
        .btn-logout { background: rgba(239,68,68,0.2); color: var(--danger-color); border: 1px solid var(--danger-color); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-logout:hover { background: var(--danger-color); color: white; }
        .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: 25px; margin-bottom: 20px; }
        .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; }
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), #1e40af); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #dc2626); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #d97706); color: white; }
        .btn-secondary { background: rgba(100,116,139,0.3); color: var(--text-primary); border: 1px solid var(--card-border); }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px; background: rgba(15,23,42,0.5); border: 1px solid var(--card-border); border-radius: 10px; color: var(--text-primary); font-family: inherit; }
        .form-input:focus { outline: none; border-color: var(--primary-color); }
        .table-wrapper { overflow-x: auto; border-radius: 10px; border: 1px solid var(--card-border); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--card-border); }
        th { background: rgba(15,23,42,0.5); font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: rgba(16,185,129,0.2); color: var(--success-color); }
        .badge-danger { background: rgba(239,68,68,0.2); color: var(--danger-color); }
        .badge-warning { background: rgba(245,158,11,0.2); color: var(--warning-color); }
        .badge-muted { background: rgba(100,116,139,0.2); color: var(--text-muted); }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: 35px; max-width: 450px; width: 100%; }
        .login-title { font-size: 1.8rem; text-align: center; margin-bottom: 5px; }
        .login-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 25px; }
        .clock-display { background: linear-gradient(135deg, rgba(37,99,235,0.15), rgba(37,99,235,0.05)); border: 2px solid rgba(37,99,235,0.3); border-radius: 20px; padding: 25px; text-align: center; margin-bottom: 20px; }
        .current-time { font-family: 'JetBrains Mono', monospace; font-size: 3rem; font-weight: 700; }
        .current-date { color: var(--text-secondary); margin-top: 8px; }
        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: 600; margin-top: 12px; }
        .status-badge.working { background: rgba(16,185,129,0.2); color: var(--success-color); animation: pulse 2s infinite; }
        .status-badge.finished { background: rgba(37,99,235,0.2); color: var(--primary-color); }
        .status-badge.pending { background: rgba(100,116,139,0.2); color: var(--text-muted); }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.6; } }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .btn-entry { background: linear-gradient(135deg, var(--success-color), #059669); color: white; padding: 18px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }
        .btn-exit { background: linear-gradient(135deg, var(--danger-color), #dc2626); color: white; padding: 18px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }
        .btn-no-work { background: linear-gradient(135deg, var(--warning-color), #d97706); color: white; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; font-family: inherit; }
        .time-box { background: rgba(15,23,42,0.5); border: 1px solid var(--card-border); border-radius: 12px; padding: 15px; margin: 15px 0; }
        .time-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(51,65,85,0.3); }
        .time-row:last-child { border: none; }
        .time-value { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 1.1rem; }
        .geo-box { background: rgba(37,99,235,0.1); border: 1px solid rgba(37,99,235,0.3); border-radius: 12px; padding: 15px; margin-top: 15px; }
        .geo-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.85rem; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .info-box { background: rgba(15,23,42,0.5); border: 1px solid var(--card-border); border-radius: 12px; padding: 15px; text-align: center; }
        .info-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .info-value { font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; font-weight: 700; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; background: rgba(15,23,42,0.5); border: 1px solid var(--card-border); border-radius: 10px; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-family: inherit; }
        .tab-btn.active { background: var(--primary-color); border-color: var(--primary-color); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .emp-card { background: rgba(15,23,42,0.5); border: 2px solid var(--card-border); border-radius: 15px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .emp-card.working { border-color: var(--success-color); background: rgba(16,185,129,0.1); }
        .emp-card.finished { border-color: var(--primary-color); background: rgba(37,99,235,0.1); }
        .emp-card.absent { border-color: var(--danger-color); background: rgba(239,68,68,0.1); }
        .emp-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), #1e40af); display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .emp-info { display: flex; align-items: center; gap: 15px; }
        .emp-details h4 { margin-bottom: 3px; }
        .emp-details p { font-size: 0.8rem; color: var(--text-muted); }
        .map-container { height: 400px; border-radius: 15px; overflow: hidden; border: 2px solid var(--card-border); }
        #adminMap, #locationMap, #detailMap { height: 100%; width: 100%; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal.show { display: flex; }
        .modal-content { background: var(--card-bg); border-radius: 20px; padding: 25px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--card-border); }
        .modal-content.large { max-width: 900px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; font-weight: 600; z-index: 2000; transform: translateX(400px); transition: transform 0.3s; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--success-color); color: white; }
        .notification.error { background: var(--danger-color); color: white; }
        .demo-card { background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(37,99,235,0.05)); border: 1px solid rgba(37,99,235,0.3); border-radius: 12px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: transform 0.2s; }
        .demo-card:hover { transform: translateY(-2px); }
        .demo-card.emp { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border-color: rgba(16,185,129,0.3); }
        code { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; }
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .stat-card { background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(37,99,235,0.05)); border: 1px solid rgba(37,99,235,0.3); border-radius: 15px; padding: 20px; margin-bottom: 15px; }
        .stat-card.success { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border-color: rgba(16,185,129,0.3); }
        .stat-card.warning { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05)); border-color: rgba(245,158,11,0.3); }
        .stat-card.danger { background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(239,68,68,0.05)); border-color: rgba(239,68,68,0.3); }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 2rem; font-weight: 700; }
        .detail-section { margin-bottom: 25px; }
        .detail-section h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px; border-bottom: 1px solid var(--card-border); padding-bottom: 10px; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), #1e40af); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; }
        .profile-info h2 { margin-bottom: 5px; }
        .profile-info p { color: var(--text-muted); font-size: 0.9rem; }
        @media (max-width: 768px) {
            .navbar { flex-direction: column; text-align: center; }
            .action-buttons { grid-template-columns: 1fr; }
            .current-time { font-size: 2.2rem; }
            .emp-card { flex-direction: column; text-align: center; }
            .modal-content { padding: 20px; margin: 10px; }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>

    <!-- LOGIN -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <h1 class="login-title">ğŸ“ Sistema de Asistencia</h1>
                <p class="login-subtitle">Control de Personal con GeolocalizaciÃ³n</p>
                <div id="loginError" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--danger-color);padding:12px;border-radius:10px;margin-bottom:15px;display:none;"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ Usuario o Email</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="Ingresa tu usuario" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ”’ ContraseÃ±a</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="ContraseÃ±a" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%;">INICIAR SESIÃ“N</button>
                </form>
                <div style="text-align:center;margin-top:20px;">
                    <a href="#" onclick="showRegisterModal()" style="color:var(--primary-color);text-decoration:none;font-weight:600;">ğŸ“ Registrar mi Empresa</a>
                </div>
                <div style="margin-top:25px;padding-top:20px;border-top:1px solid var(--card-border);">
                    <h4 style="text-align:center;margin-bottom:15px;color:var(--text-secondary);">ğŸ¯ Cuentas Demo</h4>
                    <div class="demo-card" onclick="fillLogin('admin','123')">
                        <strong style="color:var(--primary-color);">ğŸ‘‘ Administrador</strong><br>
                        <small>Usuario: <code>admin</code> | ContraseÃ±a: <code>123</code></small>
                    </div>
                    <div class="demo-card emp" onclick="fillLogin('jperez','123')">
                        <strong style="color:var(--success-color);">ğŸ‘¤ Juan PÃ©rez</strong><br>
                        <small>Usuario: <code>jperez</code> | ContraseÃ±a: <code>123</code></small>
                    </div>
                    <div class="demo-card emp" onclick="fillLogin('mgarcia','123')">
                        <strong style="color:var(--success-color);">ğŸ‘¤ MarÃ­a GarcÃ­a</strong><br>
                        <small>Usuario: <code>mgarcia</code> | ContraseÃ±a: <code>123</code></small>
                    </div>
                    <div class="demo-card" onclick="fillLogin('demo@empresa.com','demo123')" style="background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(245,158,11,0.05));border-color:rgba(245,158,11,0.3);margin-top:10px;">
                        <strong style="color:var(--warning-color);">ğŸ¢ Empresa Sin Acceso</strong>
                        <span style="background:rgba(239,68,68,0.2);color:var(--danger-color);padding:2px 8px;border-radius:10px;font-size:0.7rem;margin-left:8px;">PENDIENTE</span><br>
                        <small style="color:var(--text-muted);">Email: <code>demo@empresa.com</code> | Pass: <code>demo123</code></small>
                    </div>
                </div>
                <button onclick="resetAllData()" style="width:100%;margin-top:15px;background:transparent;border:1px solid var(--card-border);color:var(--text-muted);padding:8px;border-radius:8px;cursor:pointer;font-size:0.8rem;">ğŸ”„ Resetear Datos Demo</button>
            </div>
        </div>
    </div>

    <!-- PANTALLA ACCESO RESTRINGIDO (Empresa no aprobada) -->
    <div id="restrictedScreen" class="screen">
        <div class="container" style="max-width:700px;margin-top:50px;">
            <div class="card" style="text-align:center;border:2px solid var(--warning-color);">
                <div style="font-size:5rem;margin-bottom:20px;">âš ï¸</div>
                <h1 style="color:var(--warning-color);margin-bottom:15px;">Acceso Restringido</h1>
                <p style="color:var(--text-secondary);font-size:1.1rem;margin-bottom:25px;">
                    Su empresa aÃºn no tiene acceso habilitado a esta funciÃ³n.
                </p>
                
                <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:15px;padding:25px;margin-bottom:25px;">
                    <h3 style="color:var(--danger-color);margin-bottom:15px;">ğŸš« Funciones Bloqueadas</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;text-align:left;">
                        <div style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">âŒ Agregar empleados</div>
                        <div style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">âŒ Marcar asistencia</div>
                        <div style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">âŒ Ver reportes</div>
                        <div style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">âŒ Configuraciones</div>
                    </div>
                </div>
                
                <div style="background:rgba(37,99,235,0.1);border:1px solid rgba(37,99,235,0.3);border-radius:15px;padding:25px;margin-bottom:25px;">
                    <h3 style="color:var(--primary-color);margin-bottom:15px;">ğŸ“§ Contacte al Administrador</h3>
                    <p style="color:var(--text-secondary);margin-bottom:15px;">
                        Para activar el servicio, comunÃ­quese con el administrador de la plataforma:
                    </p>
                    <div style="background:rgba(37,99,235,0.2);padding:15px;border-radius:10px;">
                        <span style="font-size:1.2rem;font-weight:700;color:var(--primary-color);">ğŸ“§ soporte@sistema.com</span>
                    </div>
                </div>
                
                <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:15px;padding:20px;margin-bottom:25px;">
                    <h4 style="color:var(--success-color);margin-bottom:10px;">ğŸ“‹ Estado de su Solicitud</h4>
                    <div style="display:flex;justify-content:center;align-items:center;gap:15px;">
                        <span class="badge badge-warning" style="font-size:1rem;padding:10px 20px;" id="restrictedStatus">â³ Pendiente de AprobaciÃ³n</span>
                    </div>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-top:15px;" id="restrictedCompanyName">Empresa: Demo</p>
                </div>
                
                <button class="btn btn-danger" onclick="logout()" style="padding:15px 40px;">ğŸšª Cerrar SesiÃ³n</button>
            </div>
        </div>
    </div>

    <!-- EMPLOYEE SCREEN -->
    <div id="employeeScreen" class="screen">
        <div class="container">
            <nav class="navbar">
                <span class="navbar-brand">ğŸ“ Mi Asistencia</span>
                <div class="navbar-user">
                    <div><div class="user-name" id="empUserName">Empleado</div><div class="user-role">ğŸ‘¤ Empleado</div></div>
                    <button class="btn-logout" onclick="logout()">Salir</button>
                </div>
            </nav>
            <div class="card">
                <h2 class="card-title">â° Registro de Asistencia</h2>
                <div class="clock-display">
                    <div class="current-time" id="currentTime">00:00:00</div>
                    <div class="current-date" id="currentDate">Cargando...</div>
                    <div class="status-badge pending" id="workStatus">â³ Sin iniciar</div>
                </div>
                <div class="time-box">
                    <div class="time-row"><span>ğŸŸ¢ Entrada:</span><span class="time-value" id="entryTimeDisplay">--:--</span></div>
                    <div class="time-row"><span>ğŸ”´ Salida:</span><span class="time-value" id="exitTimeDisplay">--:--</span></div>
                    <div class="time-row"><span>â±ï¸ Trabajado:</span><span class="time-value" id="workedTimeDisplay" style="color:var(--success-color)">0:00:00</span></div>
                </div>
                <div class="geo-box" id="geoInfo" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h4 style="color:var(--primary-color);margin:0;">ğŸ“ Tu UbicaciÃ³n EN VIVO</h4>
                        <span id="trackingStatus" style="background:var(--danger-color);color:white;padding:3px 8px;border-radius:10px;font-size:0.7rem;animation:blink 1s infinite;">ğŸ”´ RASTREANDO</span>
                    </div>
                    <style>
                        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
                        @keyframes pulse-ring{0%{transform:scale(0.5);opacity:1}100%{transform:scale(2);opacity:0}}
                        .live-dot{width:12px;height:12px;background:#ef4444;border-radius:50%;display:inline-block;margin-right:5px;position:relative;}
                        .live-dot::before{content:'';position:absolute;width:100%;height:100%;background:#ef4444;border-radius:50%;animation:pulse-ring 1.5s infinite;}
                    </style>
                    
                    <!-- MAPA EN VIVO DEL EMPLEADO -->
                    <div id="employeeLiveMap" style="height:200px;border-radius:12px;margin-bottom:15px;border:2px solid var(--primary-color);"></div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                        <div style="background:rgba(16,185,129,0.1);padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:0.7rem;color:var(--text-muted);">LATITUD</div>
                            <div id="geoLat" style="font-weight:bold;font-family:monospace;">--</div>
                        </div>
                        <div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:0.7rem;color:var(--text-muted);">LONGITUD</div>
                            <div id="geoLng" style="font-weight:bold;font-family:monospace;">--</div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                        <div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:0.7rem;color:var(--text-muted);">PRECISIÃ“N</div>
                            <div id="geoAccuracy" style="font-weight:bold;">--</div>
                        </div>
                        <div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center;">
                            <div style="font-size:0.7rem;color:var(--text-muted);">VELOCIDAD</div>
                            <div id="geoSpeed" style="font-weight:bold;">0 km/h</div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(37,99,235,0.1);padding:10px;border-radius:8px;margin-bottom:10px;">
                        <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:5px;">ğŸ“ DIRECCIÃ“N</div>
                        <div id="geoAddress" style="font-size:0.85rem;">Obteniendo direcciÃ³n...</div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div id="locationHistoryCount" style="padding:10px;background:rgba(16,185,129,0.1);border-radius:8px;font-size:0.8rem;color:var(--success-color);text-align:center;">
                            ğŸ“Š Ubicaciones: <strong>0</strong>
                        </div>
                        <div id="lastUpdateTime" style="padding:10px;background:rgba(239,68,68,0.1);border-radius:8px;font-size:0.8rem;color:var(--danger-color);text-align:center;">
                            <span class="live-dot"></span> <span id="lastUpdateText">--:--:--</span>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-entry" id="btnEntry" onclick="markEntry()">ğŸŸ¢ MARCAR ENTRADA</button>
                    <button class="btn-exit" id="btnExit" onclick="markExit()" disabled>ğŸ”´ MARCAR SALIDA</button>
                </div>
                <button class="btn-no-work" id="btnNoWork" onclick="showNoWorkForm()">ğŸš« NO TRABAJO HOY</button>
                <div id="noWorkForm" style="display:none;margin-top:15px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);padding:20px;border-radius:12px;">
                    <div style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:10px;padding:15px;margin-bottom:20px;">
                        <h4 style="color:var(--danger-color);margin-bottom:10px;">âš ï¸ IMPORTANTE</h4>
                        <p style="color:var(--text-secondary);font-size:0.85rem;margin:0;">
                            Esta opciÃ³n <strong>SOLO</strong> debe usarse en caso de:
                        </p>
                        <ul style="color:var(--text-secondary);font-size:0.85rem;margin:10px 0 0 20px;line-height:1.8;">
                            <li>ğŸ“‹ Permiso autorizado por su supervisor</li>
                            <li>ğŸ¥ Cita mÃ©dica o emergencia de salud</li>
                            <li>ğŸ–ï¸ DÃ­a de vacaciones programado</li>
                            <li>ğŸ‰ Feriado oficial</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“Œ Tipo de Ausencia: *</label>
                        <select id="noWorkType" class="form-input" required>
                            <option value="">-- Selecciona el motivo --</option>
                            <option value="Permiso">ğŸ“‹ Permiso</option>
                            <option value="Cita MÃ©dica">ğŸ¥ Cita MÃ©dica</option>
                            <option value="Vacaciones">ğŸ–ï¸ Vacaciones</option>
                            <option value="Feriado">ğŸ‰ Feriado</option>
                            <option value="Emergencia Familiar">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Emergencia Familiar</option>
                            <option value="Otro">ğŸ“ Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“ DescripciÃ³n (Detalle el motivo): *</label>
                        <textarea id="noWorkDetail" class="form-input" rows="3" placeholder="Ejemplo: Tengo cita mÃ©dica programada con el Dr. GarcÃ­a a las 10:00 AM en el Hospital Regional..." required></textarea>
                        <small style="color:var(--text-muted);font-size:0.75rem;">MÃ­nimo 10 caracteres. Sea especÃ­fico para facilitar la aprobaciÃ³n.</small>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;">
                        <button class="btn btn-success" style="flex:1" onclick="confirmNoWork()">âœ… Confirmar Ausencia</button>
                        <button class="btn btn-secondary" style="flex:1" onclick="cancelNoWork()">âŒ Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
                    <h2 class="card-title" style="margin:0;">ğŸ’° Mi ConfiguraciÃ³n y Ganancias</h2>
                    <select id="empEarningsMonth" class="form-input" style="width:auto;" onchange="calculateEmpEarnings()"></select>
                </div>
                <div class="info-grid" style="margin-bottom:20px;">
                    <div class="info-box"><div class="info-label">ğŸ’µ Sueldo Base</div><div class="info-value" id="empSalary">S/ 0</div></div>
                    <div class="info-box"><div class="info-label">â° Horas/DÃ­a</div><div class="info-value" id="empHours">0h</div></div>
                    <div class="info-box"><div class="info-label">ğŸ’° Valor/Hora</div><div class="info-value" id="empHourlyRate">S/ 0</div></div>
                </div>
                
                <div style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(16,185,129,0.05));border:2px solid rgba(16,185,129,0.3);border-radius:15px;padding:20px;margin-bottom:20px;">
                    <h3 style="color:var(--success-color);margin-bottom:15px;text-align:center;">ğŸ“Š Resumen del Mes</h3>
                    <div class="info-grid">
                        <div class="info-box" style="background:rgba(0,0,0,0.2);">
                            <div class="info-label">ğŸ“… DÃ­as Trabajados</div>
                            <div class="info-value" id="empDaysWorked" style="color:var(--primary-color);">0</div>
                        </div>
                        <div class="info-box" style="background:rgba(0,0,0,0.2);">
                            <div class="info-label">â±ï¸ Horas Normales</div>
                            <div class="info-value" id="empNormalHours" style="color:var(--text-primary);">0h</div>
                        </div>
                        <div class="info-box" style="background:rgba(0,0,0,0.2);">
                            <div class="info-label">ğŸ”¥ Horas Extras</div>
                            <div class="info-value" id="empOvertimeHours" style="color:var(--warning-color);">0h</div>
                        </div>
                        <div class="info-box" style="background:rgba(0,0,0,0.2);">
                            <div class="info-label">ğŸ’° Pago H.Extras</div>
                            <div class="info-value" id="empOvertimePay" style="color:var(--warning-color);">S/ 0</div>
                        </div>
                    </div>
                </div>
                
                <div style="background:linear-gradient(135deg,rgba(37,99,235,0.15),rgba(37,99,235,0.05));border:2px solid rgba(37,99,235,0.4);border-radius:15px;padding:25px;text-align:center;">
                    <div style="font-size:0.9rem;color:var(--text-muted);margin-bottom:5px;">ğŸ’ TOTAL A RECIBIR</div>
                    <div style="font-family:'JetBrains Mono',monospace;font-size:2.5rem;font-weight:700;color:var(--success-color);" id="empTotalEarnings">S/ 0.00</div>
                    <div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;" id="empEarningsDetail">Sueldo base + Horas extras</div>
                </div>
            </div>
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
                    <h2 class="card-title" style="margin:0;">ğŸ“‹ Mi Historial</h2>
                    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                        <select id="historyMonth" class="form-input" style="width:auto;" onchange="loadHistory()"></select>
                        <button class="btn btn-success btn-sm" onclick="exportEmployeeExcel()">ğŸ“¥ Exportar Excel</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Fecha</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>Estado</th><th>Puntualidad</th><th>Detalle</th></tr></thead>
                        <tbody id="historyTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN SCREEN -->
    <div id="adminScreen" class="screen">
        <div class="container">
            <nav class="navbar">
                <span class="navbar-brand">ğŸ‘‘ Panel Admin</span>
                <div class="navbar-user">
                    <div><div class="user-name" id="adminUserName">Admin</div><div class="user-role">ğŸ‘‘ Administrador</div></div>
                    <button class="btn-logout" onclick="logout()">Salir</button>
                </div>
            </nav>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('tabRealtime',this)">ğŸ“ Tiempo Real</button>
                <button class="tab-btn" onclick="showTab('tabEmployees',this)">ğŸ‘¥ Empleados</button>
                <button class="tab-btn" onclick="showTab('tabHistory',this)">ğŸ“‹ Historial</button>
                <button class="tab-btn" onclick="showTab('tabMap',this)">ğŸ—ºï¸ Mapa</button>
            </div>

            <!-- TAB TIEMPO REAL -->
            <div id="tabRealtime" class="tab-content active">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                        <h2 class="card-title" style="margin:0;">ğŸ“ Estado en Tiempo Real</h2>
                        <button class="btn btn-primary" onclick="refreshStatus()">ğŸ”„ Actualizar</button>
                    </div>
                    <div class="info-grid" style="margin-bottom:20px;">
                        <div class="info-box" style="border-color:var(--success-color)"><div class="info-label">ğŸŸ¢ Trabajando</div><div class="info-value" style="color:var(--success-color)" id="countWorking">0</div></div>
                        <div class="info-box" style="border-color:var(--primary-color)"><div class="info-label">âœ… Finalizados</div><div class="info-value" style="color:var(--primary-color)" id="countFinished">0</div></div>
                        <div class="info-box" style="border-color:var(--danger-color)"><div class="info-label">ğŸ”´ Sin Marcar</div><div class="info-value" style="color:var(--danger-color)" id="countAbsent">0</div></div>
                        <div class="info-box"><div class="info-label">ğŸ“Š Total</div><div class="info-value" id="countTotal">0</div></div>
                    </div>
                    <div id="empStatusList"></div>
                </div>
            </div>

            <!-- TAB EMPLEADOS -->
            <div id="tabEmployees" class="tab-content">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                        <h2 class="card-title" style="margin:0;">ğŸ‘¥ GestiÃ³n de Empleados</h2>
                        <button class="btn btn-success" onclick="showAddEmpModal()">â• Agregar</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Usuario</th><th>Nombre</th><th>Email</th><th>Horas/DÃ­a</th><th>Sueldo</th><th>Acciones</th></tr></thead>
                            <tbody id="empTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB HISTORIAL -->
            <div id="tabHistory" class="tab-content">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                        <h2 class="card-title" style="margin:0;">ğŸ“‹ Historial</h2>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                            <select id="adminEmpFilter" class="form-input" style="width:auto;" onchange="loadAdminHistory()"><option value="all">Todos</option></select>
                            <select id="adminMonthFilter" class="form-input" style="width:auto;" onchange="loadAdminHistory()"></select>
                            <button class="btn btn-success btn-sm" onclick="exportAdminExcel()">ğŸ“¥ Exportar Excel</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Empleado</th><th>Fecha</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>Puntualidad</th><th>Estado</th><th>Detalle</th></tr></thead>
                            <tbody id="adminHistoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB MAPA -->
            <div id="tabMap" class="tab-content">
                <div class="card">
                    <h2 class="card-title">ğŸ—ºï¸ Mapa de Ubicaciones</h2>
                    <p style="color:var(--text-muted);margin-bottom:15px;">Ubicaciones de hoy. ğŸŸ¢ Entrada | ğŸ”´ Salida</p>
                    <div class="map-container"><div id="adminMap"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AGREGAR EMPLEADO -->
    <div id="empModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="empModalTitle">â• Agregar Empleado</h2>
                <button class="modal-close" onclick="closeEmpModal()">Ã—</button>
            </div>
            <form id="empForm">
                <input type="hidden" id="editingEmpUser">
                <div class="form-group"><label class="form-label">Usuario</label><input type="text" id="newEmpUser" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Nombre</label><input type="text" id="newEmpName" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" id="newEmpEmail" class="form-input" required></div>
                <div class="form-group"><label class="form-label">ContraseÃ±a</label><input type="password" id="newEmpPass" class="form-input" placeholder="Dejar vacÃ­o para no cambiar"></div>
                
                <div style="background:rgba(37,99,235,0.1);border:1px solid rgba(37,99,235,0.3);border-radius:12px;padding:15px;margin-bottom:15px;">
                    <h4 style="color:var(--primary-color);margin-bottom:15px;">â° Horario de Trabajo</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">ğŸŸ¢ Hora Entrada</label>
                            <input type="time" id="newEmpEntryTime" class="form-input" value="08:00" required>
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label class="form-label">ğŸ”´ Hora Salida</label>
                            <input type="time" id="newEmpExitTime" class="form-input" value="17:00" required>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:15px;margin-bottom:0;">
                        <label class="form-label">â±ï¸ Tolerancia de Tardanza (minutos)</label>
                        <input type="number" id="newEmpTolerance" class="form-input" value="15" min="0" max="60">
                        <small style="color:var(--text-muted);font-size:0.75rem;">Minutos de gracia antes de considerar tardanza</small>
                    </div>
                </div>
                
                <div class="form-group"><label class="form-label">Horas/DÃ­a</label><input type="number" id="newEmpHours" class="form-input" value="8" min="1" max="24" required></div>
                <div class="form-group"><label class="form-label">Sueldo Mensual (S/)</label><input type="number" id="newEmpSalary" class="form-input" value="1500" required></div>
                <div class="form-group">
                    <label class="form-label">DÃ­as Laborales</label>
                    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;">
                        <label><input type="checkbox" name="workDays" value="1" checked> Lun</label>
                        <label><input type="checkbox" name="workDays" value="2" checked> Mar</label>
                        <label><input type="checkbox" name="workDays" value="3" checked> MiÃ©</label>
                        <label><input type="checkbox" name="workDays" value="4" checked> Jue</label>
                        <label><input type="checkbox" name="workDays" value="5" checked> Vie</label>
                        <label><input type="checkbox" name="workDays" value="6"> SÃ¡b</label>
                        <label><input type="checkbox" name="workDays" value="0"> Dom</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%;">âœ… Guardar</button>
            </form>
        </div>
    </div>

    <!-- MODAL REGISTRO DE EMPRESA -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ Registrar Empresa</h2>
                <button class="modal-close" onclick="closeRegisterModal()">Ã—</button>
            </div>
            <form id="registerForm">
                <div class="form-group"><label class="form-label">ğŸ¢ Nombre de Empresa *</label><input type="text" id="regCompanyName" class="form-input" required></div>
                <div class="form-group"><label class="form-label">ğŸ“„ RUC</label><input type="text" id="regCompanyRuc" class="form-input" maxlength="11"></div>
                <div class="form-group"><label class="form-label">ğŸ“§ Email del Admin *</label><input type="email" id="regAdminEmail" class="form-input" required></div>
                <div class="form-group"><label class="form-label">ğŸ‘¤ Nombre del Admin *</label><input type="text" id="regAdminName" class="form-input" required></div>
                <div class="form-group"><label class="form-label">ğŸ“± TelÃ©fono</label><input type="tel" id="regPhone" class="form-input"></div>
                <div class="form-group"><label class="form-label">ğŸ”’ ContraseÃ±a *</label><input type="password" id="regPassword" class="form-input" required minlength="6"></div>
                <div class="form-group"><label class="form-label">ğŸ”’ Confirmar ContraseÃ±a *</label><input type="password" id="regPasswordConfirm" class="form-input" required></div>
                
                <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:10px;padding:15px;margin-bottom:20px;">
                    <p style="color:var(--warning-color);font-size:0.85rem;margin:0;">
                        âš ï¸ <strong>Importante:</strong> Su registro quedarÃ¡ pendiente de aprobaciÃ³n. RecibirÃ¡ un correo cuando su cuenta sea activada.
                    </p>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width:100%;">ğŸ“ Enviar Solicitud</button>
            </form>
        </div>
    </div>

    <!-- MODAL DETALLE EMPLEADO (MEJORADO) -->
    <div id="detailModal" class="modal">
        <div class="modal-content large" style="max-width:1000px;">
            <div class="modal-header">
                <h2>ğŸ“Š Detalle del Empleado</h2>
                <button class="modal-close" onclick="closeDetailModal()">Ã—</button>
            </div>
            <div id="detailModalHeader" style="margin-bottom:20px;"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                <h3 style="margin:0;color:var(--text-secondary);">ğŸ“… Filtrar por Mes</h3>
                <select id="detailMonthFilter" class="form-input" style="width:auto;" onchange="updateDetailModal()"></select>
            </div>
            <div id="detailModalContent"></div>
        </div>
    </div>

    <!-- MODAL UBICACIÃ“N -->
    <div id="locModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h2>ğŸ“ UbicaciÃ³n</h2>
                <button class="modal-close" onclick="closeLocModal()">Ã—</button>
            </div>
            <div id="locModalInfo"></div>
            <div class="map-container" style="height:300px;margin-top:15px;"><div id="locationMap"></div></div>
        </div>
    </div>

    <!-- ========== SUPER ADMIN SCREEN (OCULTO) ========== -->
    <div id="superAdminScreen" class="screen">
        <div class="container">
            <nav class="navbar" style="border:2px solid var(--warning-color);">
                <span class="navbar-brand">âš¡ Super Admin</span>
                <div class="navbar-user">
                    <div><div class="user-name">Super Administrador</div><div class="user-role">ğŸ” Control Total</div></div>
                    <button class="btn-logout" onclick="logout()">Salir</button>
                </div>
            </nav>
            
            <div class="info-grid" style="margin-bottom:20px;">
                <div class="info-box" style="border-color:var(--primary-color)"><div class="info-label">ğŸ¢ Empresas</div><div class="info-value" id="superTotalCompanies">0</div></div>
                <div class="info-box" style="border-color:var(--warning-color)"><div class="info-label">â³ Pendientes</div><div class="info-value" id="superPendingCompanies">0</div></div>
                <div class="info-box" style="border-color:var(--success-color)"><div class="info-label">âœ… Aprobadas</div><div class="info-value" id="superApprovedCompanies">0</div></div>
                <div class="info-box" style="border-color:var(--danger-color)"><div class="info-label">ğŸš« Suspendidas</div><div class="info-value" id="superSuspendedCompanies">0</div></div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showSuperTab('tabSuperCompanies',this)">ğŸ¢ Empresas</button>
                <button class="tab-btn" onclick="showSuperTab('tabSuperRegister',this)">â• Registrar Empresa</button>
            </div>

            <div id="tabSuperCompanies" class="tab-content active">
                <div class="card">
                    <h2 class="card-title">ğŸ¢ GestiÃ³n de Empresas</h2>
                    <div id="superCompanyList"></div>
                </div>
            </div>

            <div id="tabSuperRegister" class="tab-content">
                <div class="card">
                    <h2 class="card-title">â• Registrar Nueva Empresa</h2>
                    <form id="superRegisterForm">
                        <div class="form-group"><label class="form-label">Nombre de Empresa</label><input type="text" id="superCompanyName" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">RUC</label><input type="text" id="superCompanyRuc" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Email Admin</label><input type="email" id="superCompanyEmail" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">Usuario Admin</label><input type="text" id="superCompanyUser" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">ContraseÃ±a Admin</label><input type="password" id="superCompanyPass" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">Plan</label>
                            <select id="superCompanyPlan" class="form-input">
                                <option value="free">Gratuito (5 empleados)</option>
                                <option value="basic">BÃ¡sico (20 empleados)</option>
                                <option value="pro" selected>Profesional (50 empleados)</option>
                                <option value="enterprise">Empresarial (Ilimitado)</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">MÃ¡x. Empleados</label><input type="number" id="superCompanyMaxEmp" class="form-input" value="50" min="1"></div>
                        <div class="form-group"><label class="form-label">Estado</label>
                            <select id="superCompanyStatus" class="form-input">
                                <option value="pending">â³ Pendiente</option>
                                <option value="approved" selected>âœ… Aprobada</option>
                                <option value="suspended">ğŸš« Suspendida</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success" style="width:100%;">âœ… Crear Empresa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURAR EMPRESA (Super Admin) -->
    <div id="configCompanyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ Configurar Empresa</h2>
                <button class="modal-close" onclick="closeConfigCompanyModal()">Ã—</button>
            </div>
            <div id="configCompanyInfo" style="margin-bottom:20px;"></div>
            <form id="configCompanyForm">
                <input type="hidden" id="configCompanyId">
                <div class="form-group"><label class="form-label">Estado</label>
                    <select id="configCompanyStatus" class="form-input">
                        <option value="pending">â³ Pendiente</option>
                        <option value="approved">âœ… Aprobada</option>
                        <option value="suspended">ğŸš« Suspendida</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Plan</label>
                    <select id="configCompanyPlan" class="form-input">
                        <option value="free">Gratuito</option>
                        <option value="basic">BÃ¡sico</option>
                        <option value="pro">Profesional</option>
                        <option value="enterprise">Empresarial</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">MÃ¡x. Empleados</label><input type="number" id="configCompanyMaxEmp" class="form-input" value="50" min="1"></div>
                <button type="submit" class="btn btn-success" style="width:100%;">ğŸ’¾ Guardar</button>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2 style="color:var(--danger-color);">âš ï¸ Eliminar Empleado</h2>
                <button class="modal-close" onclick="closeDeleteModal()">Ã—</button>
            </div>
            <div id="deleteModalContent">
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:4rem;margin-bottom:15px;">ğŸ—‘ï¸</div>
                    <h3 id="deleteEmpName" style="margin-bottom:10px;">Nombre del Empleado</h3>
                    <p style="color:var(--text-muted);">@<span id="deleteEmpUser">usuario</span></p>
                </div>
                
                <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:20px;margin-bottom:20px;">
                    <h4 style="color:var(--danger-color);margin-bottom:15px;">âš ï¸ ADVERTENCIA IMPORTANTE</h4>
                    <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:12px;">
                        Esta acciÃ³n <strong>solo debe realizarse</strong> en los siguientes casos:
                    </p>
                    <ul style="color:var(--text-secondary);font-size:0.85rem;margin-left:20px;line-height:1.8;">
                        <li>ğŸš« <strong>Despido</strong> del empleado</li>
                        <li>ğŸ“ <strong>Renuncia</strong> voluntaria</li>
                        <li>ğŸ“‹ <strong>Fin de contrato</strong></li>
                        <li>ğŸ”„ <strong>Duplicado</strong> por error</li>
                    </ul>
                </div>
                
                <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:15px;margin-bottom:20px;">
                    <p style="color:var(--warning-color);font-size:0.85rem;margin:0;">
                        <strong>ğŸ“Œ Nota:</strong> Se eliminarÃ¡n todos los datos del empleado. El historial de asistencia se mantendrÃ¡ para fines de registro.
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Para confirmar, escribe el usuario del empleado:</label>
                    <input type="text" id="deleteConfirmInput" class="form-input" placeholder="Escribe el usuario aquÃ­...">
                </div>
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn btn-secondary" style="flex:1;" onclick="closeDeleteModal()">âŒ Cancelar</button>
                    <button class="btn btn-danger" style="flex:1;" id="confirmDeleteBtn" onclick="confirmDeleteEmp()" disabled>ğŸ—‘ï¸ Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        const USERS_KEY = 'geo_users';
        const ATTENDANCE_KEY = 'geo_attendance';
        let currentUser = null;
        let clockInterval = null;
        let todayRecord = null;
        let adminMap = null;
        let locMap = null;
        let detailMap = null;

        // UTILS
        function notify(msg, type='success') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = `notification ${type} show`;
            setTimeout(() => n.classList.remove('show'), 3000);
        }
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function formatMoney(v) { return 'S/ ' + parseFloat(v).toFixed(2); }
        function formatHours(h) { const hr = Math.floor(h); const mn = Math.round((h-hr)*60); return `${hr}:${mn.toString().padStart(2,'0')}`; }
        function getTodayKey() { const d = new Date(); return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`; }
        function getDayName(n) { return ['Dom','Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b'][n]; }
        function getMonthName(n) { return ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][n]; }

        // STORAGE
        function getUsers() { const d = localStorage.getItem(USERS_KEY); return d ? JSON.parse(d) : {}; }
        function saveUsers(u) { localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
        function getRecords() { const d = localStorage.getItem(ATTENDANCE_KEY); return d ? JSON.parse(d) : {}; }
        function saveRecords(r) { localStorage.setItem(ATTENDANCE_KEY, JSON.stringify(r)); }
        function getEmployees() { return Object.values(getUsers()).filter(u => u.role === 'employee' && u.active); }
        function getCompanies() { const d = localStorage.getItem('COMPANIES_KEY'); return d ? JSON.parse(d) : {}; }
        function saveCompanies(c) { localStorage.setItem('COMPANIES_KEY', JSON.stringify(c)); }

        // SUPER ADMIN CONFIG (SECRETO)
        const SUPER_ADMIN_EMAIL = 'superadmin@sistema.com';
        const SUPER_ADMIN_USER = 'superadmin';
        const SUPER_ADMIN_PASS = 'super123';

        // WEB NOTIFICATIONS
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        function sendBrowserNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: 'ğŸ“' });
            }
        }

        // DEMO DATA
        function loadDemo() {
            const companies = {
                'default': { id:'default', name:'Empresa Activa Demo', ruc:'20123456789', status:'approved', plan:'pro', maxEmployees:50, createdAt:new Date().toISOString() },
                'demo_company': { id:'demo_company', name:'Empresa Pendiente', ruc:'12345678901', status:'pending', plan:'free', maxEmployees:5, createdAt:new Date().toISOString() }
            };
            const users = {
                'superadmin': { username:'superadmin', password:'super123', fullName:'Super Administrador', email:SUPER_ADMIN_EMAIL, role:'superadmin', active:true },
                'admin': { username:'admin', password:'123', fullName:'Administrador', role:'admin', companyId:'default', active:true },
                'jperez': { username:'jperez', password:'123', fullName:'Juan PÃ©rez', email:'juan@empresa.com', role:'employee', companyId:'default', active:true, config:{ dailyHours:8, workDays:[1,2,3,4,5], monthlySalary:2000, overtimeRate:1.5, scheduleEntry:'08:00', scheduleExit:'17:00', tolerance:15 }},
                'mgarcia': { username:'mgarcia', password:'123', fullName:'MarÃ­a GarcÃ­a', email:'maria@empresa.com', role:'employee', companyId:'default', active:true, config:{ dailyHours:6, workDays:[1,2,3,4,5,6], monthlySalary:1500, overtimeRate:1.5, scheduleEntry:'09:00', scheduleExit:'16:00', tolerance:10 }},
                'demo@empresa.com': { username:'demo@empresa.com', password:'demo123', fullName:'Admin Demo (Sin Acceso)', email:'demo@empresa.com', role:'admin', companyId:'demo_company', active:true }
            };
            saveCompanies(companies);
            saveUsers(users);
            
            // Crear registros de asistencia de ejemplo para los Ãºltimos dÃ­as
            const records = getRecords();
            const today = new Date();
            ['jperez', 'mgarcia'].forEach(username => {
                for (let i = 1; i <= 15; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    if (d.getDay() === 0 || d.getDay() === 6) continue; // Skip weekends
                    const dateKey = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
                    const key = `${username}_${dateKey}`;
                    const entryHour = 8 + Math.floor(Math.random() * 1);
                    const entryMin = Math.floor(Math.random() * 30);
                    const exitHour = 17 + Math.floor(Math.random() * 2);
                    const exitMin = Math.floor(Math.random() * 59);
                    records[key] = {
                        username, date: dateKey,
                        entryTime: `${entryHour.toString().padStart(2,'0')}:${entryMin.toString().padStart(2,'0')}`,
                        exitTime: `${exitHour.toString().padStart(2,'0')}:${exitMin.toString().padStart(2,'0')}`,
                        entryLoc: { latitude: -12.0464 + Math.random()*0.01, longitude: -77.0428 + Math.random()*0.01, accuracy: 10, address: 'Lima, PerÃº' },
                        exitLoc: { latitude: -12.0464 + Math.random()*0.01, longitude: -77.0428 + Math.random()*0.01, accuracy: 10, address: 'Lima, PerÃº' }
                    };
                }
            });
            saveRecords(records);
        }
        function resetAllData() { if(confirm('Â¿Borrar todos los datos demo?')) { localStorage.clear(); location.reload(); }}

        // ========== SISTEMA DE TRACKING EN TIEMPO REAL CON MAPA ==========
        let locationWatchId = null;
        let currentLocation = null;
        let locationHistory = [];
        let employeeMap = null;
        let employeeMarker = null;
        let employeePath = null;
        let pathCoordinates = [];
        let trackingActive = false;
        let updateCounter = 0;
        
        function getPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) { reject(new Error('GeolocalizaciÃ³n no soportada')); return; }
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ 
                        latitude: pos.coords.latitude, 
                        longitude: pos.coords.longitude, 
                        accuracy: pos.coords.accuracy,
                        speed: pos.coords.speed || 0,
                        heading: pos.coords.heading || 0,
                        timestamp: new Date().toISOString()
                    }),
                    err => {
                        let msg = 'Error de ubicaciÃ³n';
                        if(err.code === 1) msg = 'Permiso denegado. Activa la ubicaciÃ³n en tu navegador.';
                        else if(err.code === 2) msg = 'UbicaciÃ³n no disponible. Activa el GPS.';
                        else if(err.code === 3) msg = 'Tiempo agotado. Intenta en un lugar con mejor seÃ±al.';
                        reject(new Error(msg));
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 30000,
                        maximumAge: 0
                    }
                );
            });
        }
        
        // Inicializar mapa del empleado
        function initEmployeeMap(lat, lng) {
            const mapContainer = document.getElementById('employeeLiveMap');
            if (!mapContainer) return;
            
            // Destruir mapa existente si hay
            if (employeeMap) {
                employeeMap.remove();
                employeeMap = null;
            }
            
            // Crear nuevo mapa
            employeeMap = L.map('employeeLiveMap').setView([lat, lng], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(employeeMap);
            
            // Crear marcador animado
            const pulsingIcon = L.divIcon({
                className: '',
                html: `<div style="position:relative;">
                    <div style="width:20px;height:20px;background:#ef4444;border-radius:50%;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3);"></div>
                    <div style="position:absolute;top:-5px;left:-5px;width:30px;height:30px;background:rgba(239,68,68,0.3);border-radius:50%;animation:pulse-marker 2s infinite;"></div>
                </div>
                <style>@keyframes pulse-marker{0%{transform:scale(1);opacity:1}100%{transform:scale(2);opacity:0}}</style>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            employeeMarker = L.marker([lat, lng], { icon: pulsingIcon }).addTo(employeeMap);
            employeeMarker.bindPopup('<b>ğŸ“ Tu ubicaciÃ³n actual</b>').openPopup();
            
            // Inicializar lÃ­nea del recorrido
            pathCoordinates = [[lat, lng]];
            employeePath = L.polyline(pathCoordinates, {
                color: '#3b82f6',
                weight: 4,
                opacity: 0.8
            }).addTo(employeeMap);
            
            // Agregar cÃ­rculo de precisiÃ³n
            L.circle([lat, lng], {
                radius: 50,
                color: '#10b981',
                fillColor: '#10b981',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(employeeMap);
        }
        
        // Actualizar posiciÃ³n en el mapa
        function updateMapPosition(lat, lng) {
            if (!employeeMap || !employeeMarker) return;
            
            // Mover marcador suavemente
            employeeMarker.setLatLng([lat, lng]);
            
            // Agregar punto al recorrido
            pathCoordinates.push([lat, lng]);
            if (employeePath) {
                employeePath.setLatLngs(pathCoordinates);
            }
            
            // Centrar mapa en nueva posiciÃ³n
            employeeMap.panTo([lat, lng], { animate: true, duration: 0.5 });
        }
        
        // Iniciar tracking continuo con mapa en vivo
        function startLocationTracking() {
            if (trackingActive) return;
            trackingActive = true;
            updateCounter = 0;
            
            if (!navigator.geolocation) {
                console.error('GeolocalizaciÃ³n no soportada');
                notify('âŒ Tu navegador no soporta geolocalizaciÃ³n', 'error');
                return;
            }
            
            console.log('ğŸŸ¢ Iniciando tracking en tiempo real...');
            
            // Usar watchPosition para tracking CONTINUO
            locationWatchId = navigator.geolocation.watchPosition(
                async (pos) => {
                    updateCounter++;
                    
                    const newLocation = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        speed: pos.coords.speed || 0,
                        heading: pos.coords.heading || 0,
                        altitude: pos.coords.altitude || 0,
                        timestamp: new Date().toISOString()
                    };
                    
                    currentLocation = newLocation;
                    
                    // Actualizar mapa en vivo
                    if (employeeMap) {
                        updateMapPosition(newLocation.latitude, newLocation.longitude);
                    } else {
                        initEmployeeMap(newLocation.latitude, newLocation.longitude);
                    }
                    
                    // Actualizar interfaz
                    updateLiveLocationUI(newLocation);
                    
                    // Guardar en historial cada 30 segundos (cada 3 actualizaciones aprox)
                    if (updateCounter % 3 === 0) {
                        await saveLocationToHistory(newLocation);
                    }
                    
                    console.log(`ğŸ“ [${updateCounter}] Lat: ${newLocation.latitude.toFixed(6)}, Lng: ${newLocation.longitude.toFixed(6)}, PrecisiÃ³n: ${newLocation.accuracy.toFixed(0)}m`);
                },
                (err) => {
                    console.error('âŒ Error de tracking:', err.message);
                    const statusEl = document.getElementById('trackingStatus');
                    if (statusEl) {
                        statusEl.style.background = '#f59e0b';
                        statusEl.textContent = 'âš ï¸ GPS ERROR';
                    }
                },
                {
                    enableHighAccuracy: true,  // MÃ¡xima precisiÃ³n (usa GPS)
                    timeout: 10000,            // 10 segundos mÃ¡ximo de espera
                    maximumAge: 0              // NUNCA usar cachÃ©, siempre ubicaciÃ³n fresca
                }
            );
            
            console.log('âœ… Tracking iniciado con watchId:', locationWatchId);
        }
        
        // Actualizar UI de ubicaciÃ³n en vivo
        function updateLiveLocationUI(loc) {
            const geoInfo = document.getElementById('geoInfo');
            if (!geoInfo) return;
            
            geoInfo.style.display = 'block';
            
            // Actualizar coordenadas
            document.getElementById('geoLat').textContent = loc.latitude.toFixed(6);
            document.getElementById('geoLng').textContent = loc.longitude.toFixed(6);
            document.getElementById('geoAccuracy').textContent = loc.accuracy.toFixed(0) + 'm';
            
            // Velocidad (convertir m/s a km/h) - manejar null/undefined
            const speed = loc.speed || 0;
            const speedKmh = (speed * 3.6).toFixed(1);
            document.getElementById('geoSpeed').textContent = speedKmh + ' km/h';
            
            // Ãšltima actualizaciÃ³n
            const now = new Date();
            document.getElementById('lastUpdateText').textContent = now.toLocaleTimeString('es-PE');
            
            // Contador de ubicaciones
            document.getElementById('locationHistoryCount').innerHTML = 
                `ğŸ“Š Ubicaciones: <strong>${locationHistory.length}</strong>`;
            
            // Indicador de estado
            const statusEl = document.getElementById('trackingStatus');
            if (statusEl) {
                if (loc.accuracy <= 20) {
                    statusEl.style.background = '#10b981';
                    statusEl.textContent = 'ğŸŸ¢ EXCELENTE';
                } else if (loc.accuracy <= 50) {
                    statusEl.style.background = '#3b82f6';
                    statusEl.textContent = 'ğŸ”µ BUENA';
                } else if (loc.accuracy <= 100) {
                    statusEl.style.background = '#f59e0b';
                    statusEl.textContent = 'ğŸŸ¡ REGULAR';
                } else {
                    statusEl.style.background = '#ef4444';
                    statusEl.textContent = 'ğŸ”´ BAJA';
                }
            }
            
            // Obtener direcciÃ³n (solo cada 5 actualizaciones para no sobrecargar)
            if (updateCounter % 5 === 1) {
                getAddress(loc.latitude, loc.longitude).then(addr => {
                    document.getElementById('geoAddress').textContent = addr;
                });
            }
        }
        
        // Guardar ubicaciÃ³n en historial
        async function saveLocationToHistory(loc) {
            if (!todayRecord || !todayRecord.entryTime || todayRecord.exitTime) return;
            
            const locWithAddress = { ...loc };
            // Solo obtener direcciÃ³n cada cierto tiempo
            if (locationHistory.length % 10 === 0) {
                locWithAddress.address = await getAddress(loc.latitude, loc.longitude);
            }
            
            locationHistory.push(locWithAddress);
            
            // Guardar en registro
            const records = getRecords();
            const key = `${currentUser.username}_${getTodayKey()}`;
            if (records[key]) {
                records[key].locationHistory = locationHistory;
                records[key].lastLocation = locWithAddress;
                saveRecords(records);
            }
            
            console.log(`ğŸ’¾ UbicaciÃ³n #${locationHistory.length} guardada en historial`);
        }
        
        // Detener tracking
        function stopLocationTracking() {
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            trackingActive = false;
            currentLocation = null;
            pathCoordinates = [];
            updateCounter = 0;
            
            // Actualizar estado visual
            const statusEl = document.getElementById('trackingStatus');
            if (statusEl) {
                statusEl.style.background = '#6b7280';
                statusEl.textContent = 'â¹ï¸ DETENIDO';
                statusEl.style.animation = 'none';
            }
            
            console.log('ğŸ”´ Tracking detenido');
        }
        
        async function getAddress(lat, lng) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`);
                const data = await res.json();
                return data.display_name || 'No disponible';
            } catch(e) { return 'No disponible'; }
        }

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', e => { e.preventDefault(); login(); });
        function fillLogin(u, p) { document.getElementById('loginUsername').value = u; document.getElementById('loginPassword').value = p; }
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const err = document.getElementById('loginError');
            const users = getUsers();
            const user = users[username];
            if (!user || user.password !== password) { err.textContent = 'Credenciales incorrectas'; err.style.display = 'block'; return; }
            currentUser = user;
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            err.style.display = 'none';
            requestNotificationPermission();
            
            if (user.role === 'superadmin') { 
                initSuperAdmin(); 
                showScreen('superAdminScreen'); 
            } else if (user.role === 'admin' || user.role === 'employee') {
                // Verificar estado de la empresa
                const companies = getCompanies();
                const company = companies[user.companyId];
                
                if (!company || company.status !== 'approved') {
                    // Mostrar pantalla de acceso restringido
                    document.getElementById('restrictedCompanyName').textContent = 'Empresa: ' + (company ? company.name : 'No asignada');
                    if (company && company.status === 'suspended') {
                        document.getElementById('restrictedStatus').textContent = 'ğŸš« Cuenta Suspendida';
                        document.getElementById('restrictedStatus').className = 'badge badge-danger';
                    } else {
                        document.getElementById('restrictedStatus').textContent = 'â³ Pendiente de AprobaciÃ³n';
                        document.getElementById('restrictedStatus').className = 'badge badge-warning';
                    }
                    showScreen('restrictedScreen');
                    notify('âš ï¸ Su empresa aÃºn no estÃ¡ aprobada', 'error');
                    return;
                }
                
                if (user.role === 'admin') { 
                    initAdmin(); 
                    showScreen('adminScreen'); 
                } else { 
                    initEmployee(); 
                    showScreen('employeeScreen'); 
                }
            }
            notify('Â¡Bienvenido, ' + user.fullName + '!');
        }
        function logout() { 
            stopLocationTracking(); // Detener tracking al cerrar sesiÃ³n
            sessionStorage.removeItem('currentUser'); 
            currentUser = null; 
            if(clockInterval) clearInterval(clockInterval); 
            showScreen('loginScreen'); 
        }
        
        // REGISTRO DE EMPRESA
        function showRegisterModal() { document.getElementById('registerModal').classList.add('show'); }
        function closeRegisterModal() { document.getElementById('registerModal').classList.remove('show'); }
        document.getElementById('registerForm').addEventListener('submit', e => {
            e.preventDefault();
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regPasswordConfirm').value;
            if (password !== confirm) { notify('âŒ Las contraseÃ±as no coinciden', 'error'); return; }
            
            const companyId = 'company_' + Date.now();
            const email = document.getElementById('regAdminEmail').value.trim();
            const companies = getCompanies();
            const users = getUsers();
            
            // Verificar email Ãºnico
            if (users[email]) { notify('âŒ El email ya estÃ¡ registrado', 'error'); return; }
            
            companies[companyId] = {
                id: companyId,
                name: document.getElementById('regCompanyName').value.trim(),
                ruc: document.getElementById('regCompanyRuc').value.trim(),
                phone: document.getElementById('regPhone').value.trim(),
                status: 'pending',
                plan: 'free',
                maxEmployees: 5,
                createdAt: new Date().toISOString()
            };
            
            users[email] = {
                username: email,
                password: password,
                fullName: document.getElementById('regAdminName').value.trim(),
                email: email,
                role: 'admin',
                companyId: companyId,
                active: true
            };
            
            saveCompanies(companies);
            saveUsers(users);
            closeRegisterModal();
            notify('âœ… Solicitud enviada. Pendiente de aprobaciÃ³n.');
            
            // Simular notificaciÃ³n por email al Super Admin
            console.log('ğŸ“§ EMAIL A SUPER ADMIN: Nueva empresa "' + companies[companyId].name + '" solicita registro');
        });

        // EMPLOYEE FUNCTIONS
        function initEmployee() {
            document.getElementById('empUserName').textContent = currentUser.fullName;
            const cfg = currentUser.config;
            const workDaysPerMonth = 22;
            const hourlyRate = cfg.monthlySalary / (workDaysPerMonth * cfg.dailyHours);
            document.getElementById('empSalary').textContent = formatMoney(cfg.monthlySalary);
            document.getElementById('empHours').textContent = cfg.dailyHours + 'h';
            document.getElementById('empHourlyRate').textContent = formatMoney(hourlyRate);
            startClock();
            loadTodayRecord();
            initHistoryFilter();
            initEmpEarningsFilter();
            
            // â­ Reanudar tracking si ya marcÃ³ entrada pero no salida
            if (todayRecord && todayRecord.entryTime && !todayRecord.exitTime && !todayRecord.noWork) {
                // Mostrar panel de ubicaciÃ³n
                document.getElementById('geoInfo').style.display = 'block';
                
                // Cargar historial existente
                locationHistory = todayRecord.locationHistory || [];
                pathCoordinates = locationHistory.map(loc => [loc.latitude, loc.longitude]);
                
                // Inicializar mapa con Ãºltima ubicaciÃ³n conocida
                if (todayRecord.lastLocation) {
                    setTimeout(() => {
                        initEmployeeMap(todayRecord.lastLocation.latitude, todayRecord.lastLocation.longitude);
                        // Dibujar recorrido existente
                        if (pathCoordinates.length > 0 && employeePath) {
                            employeePath.setLatLngs(pathCoordinates);
                        }
                    }, 500);
                } else if (todayRecord.entryLoc) {
                    setTimeout(() => {
                        initEmployeeMap(todayRecord.entryLoc.latitude, todayRecord.entryLoc.longitude);
                    }, 500);
                }
                
                // Iniciar tracking en vivo
                startLocationTracking();
                notify('ğŸ“ Tracking de ubicaciÃ³n reanudado - MAPA EN VIVO', 'success');
            }
        }
        
        // Inicializar filtro de ganancias del empleado
        function initEmpEarningsFilter() {
            const select = document.getElementById('empEarningsMonth');
            const now = new Date();
            select.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const val = `${d.getFullYear()}-${d.getMonth()}`;
                const text = `${getMonthName(d.getMonth())} ${d.getFullYear()}`;
                select.innerHTML += `<option value="${val}">${text}</option>`;
            }
            calculateEmpEarnings();
        }
        
        // Calcular ganancias del empleado
        function calculateEmpEarnings() {
            const [year, month] = document.getElementById('empEarningsMonth').value.split('-').map(Number);
            const cfg = currentUser.config;
            const records = getRecords();
            const dailyHours = cfg.dailyHours || 8;
            const monthlySalary = cfg.monthlySalary || 0;
            
            // Calcular valor por hora
            const workDaysPerMonth = 22; // Promedio dÃ­as laborales
            const hourlyRate = monthlySalary / (workDaysPerMonth * dailyHours);
            
            let daysWorked = 0;
            let totalHours = 0;
            let normalHours = 0;
            let overtimeHours = 0;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                if (date > today) continue;
                
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                const key = `${currentUser.username}_${dateKey}`;
                const rec = records[key];
                
                if (rec && rec.entryTime && rec.exitTime && !rec.noWork) {
                    daysWorked++;
                    const [eH, eM] = rec.entryTime.split(':').map(Number);
                    const [xH, xM] = rec.exitTime.split(':').map(Number);
                    const hoursWorked = (xH + xM/60) - (eH + eM/60);
                    
                    totalHours += hoursWorked;
                    
                    if (hoursWorked > dailyHours) {
                        normalHours += dailyHours;
                        overtimeHours += hoursWorked - dailyHours;
                    } else {
                        normalHours += hoursWorked;
                    }
                }
            }
            
            // Calcular pagos (hora extra = mismo valor que hora normal)
            const overtimePay = overtimeHours * hourlyRate;
            const basePay = (daysWorked / workDaysPerMonth) * monthlySalary;
            const totalEarnings = basePay + overtimePay;
            
            // Actualizar UI
            document.getElementById('empDaysWorked').textContent = daysWorked;
            document.getElementById('empNormalHours').textContent = normalHours.toFixed(2) + 'h';
            document.getElementById('empOvertimeHours').textContent = overtimeHours.toFixed(2) + 'h';
            document.getElementById('empOvertimePay').textContent = formatMoney(overtimePay);
            document.getElementById('empTotalEarnings').textContent = formatMoney(totalEarnings);
            document.getElementById('empEarningsDetail').textContent = `${formatMoney(basePay)} base + ${formatMoney(overtimePay)} extras`;
        }
        
        function startClock() {
            updateClock();
            if(clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(updateClock, 1000);
        }
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-PE');
            document.getElementById('currentDate').textContent = now.toLocaleDateString('es-PE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            if (todayRecord && todayRecord.entryTime && !todayRecord.exitTime && !todayRecord.noWork) updateWorkedTime();
        }
        function loadTodayRecord() {
            const records = getRecords();
            const key = `${currentUser.username}_${getTodayKey()}`;
            todayRecord = records[key] || null;
            updateUI();
        }
        function updateUI() {
            const btnE = document.getElementById('btnEntry');
            const btnX = document.getElementById('btnExit');
            const btnN = document.getElementById('btnNoWork');
            const entryD = document.getElementById('entryTimeDisplay');
            const exitD = document.getElementById('exitTimeDisplay');
            const status = document.getElementById('workStatus');
            const geo = document.getElementById('geoInfo');
            document.getElementById('noWorkForm').style.display = 'none';
            if (!todayRecord) {
                btnE.disabled = false; btnX.disabled = true; btnN.disabled = false;
                entryD.textContent = '--:--'; exitD.textContent = '--:--';
                status.className = 'status-badge pending'; status.textContent = 'â³ Sin iniciar';
                geo.style.display = 'none';
                document.getElementById('workedTimeDisplay').textContent = '0:00:00';
            } else if (todayRecord.noWork) {
                btnE.disabled = true; btnX.disabled = true; btnN.disabled = true;
                entryD.textContent = 'ğŸš«'; exitD.textContent = 'ğŸš«';
                status.className = 'status-badge pending'; status.textContent = 'ğŸš« ' + (todayRecord.noWorkType || 'No trabajÃ³');
                geo.style.display = 'none';
            } else if (todayRecord.entryTime && !todayRecord.exitTime) {
                btnE.disabled = true; btnX.disabled = false; btnN.disabled = true;
                entryD.textContent = todayRecord.entryTime; exitD.textContent = '--:--';
                status.className = 'status-badge working'; status.textContent = 'ğŸŸ¢ Trabajando...';
                showGeo(todayRecord.entryLoc);
                updateWorkedTime();
            } else if (todayRecord.entryTime && todayRecord.exitTime) {
                btnE.disabled = true; btnX.disabled = true; btnN.disabled = true;
                entryD.textContent = todayRecord.entryTime; exitD.textContent = todayRecord.exitTime;
                status.className = 'status-badge finished'; status.textContent = 'âœ… Finalizado';
                showGeo(todayRecord.exitLoc || todayRecord.entryLoc);
                updateWorkedTime();
            }
        }
        function showGeo(loc) {
            if(!loc) return;
            document.getElementById('geoInfo').style.display = 'block';
            document.getElementById('geoLat').textContent = loc.latitude.toFixed(6);
            document.getElementById('geoLng').textContent = loc.longitude.toFixed(6);
            document.getElementById('geoAccuracy').textContent = loc.accuracy.toFixed(0) + 'm';
            
            // Manejar elementos que pueden no existir
            const speedEl = document.getElementById('geoSpeed');
            if (speedEl) speedEl.textContent = (loc.speed ? (loc.speed * 3.6).toFixed(1) : '0') + ' km/h';
            
            const lastUpdateEl = document.getElementById('lastUpdateText');
            if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleTimeString('es-PE');
            
            document.getElementById('geoAddress').textContent = loc.address || 'Cargando...';
            if(!loc.address) getAddress(loc.latitude, loc.longitude).then(a => document.getElementById('geoAddress').textContent = a);
        }
        function updateWorkedTime() {
            if(!todayRecord || !todayRecord.entryTime) return;
            const [eH, eM] = todayRecord.entryTime.split(':').map(Number);
            const entry = new Date(); entry.setHours(eH, eM, 0, 0);
            let end;
            if(todayRecord.exitTime) { const [xH, xM] = todayRecord.exitTime.split(':').map(Number); end = new Date(); end.setHours(xH, xM, 0, 0); }
            else { end = new Date(); }
            const diff = Math.floor((end - entry) / 1000);
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            document.getElementById('workedTimeDisplay').textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
        async function markEntry() {
            try {
                document.getElementById('btnEntry').disabled = true;
                document.getElementById('btnEntry').textContent = 'ğŸ“ Obteniendo ubicaciÃ³n...';
                const loc = await getPosition();
                
                // Advertencia si la precisiÃ³n es mala (mayor a 50 metros)
                if (loc.accuracy > 50) {
                    notify('âš ï¸ PrecisiÃ³n baja: ' + Math.round(loc.accuracy) + 'm. Intenta estar al aire libre o activar GPS.', 'error');
                }
                
                loc.address = await getAddress(loc.latitude, loc.longitude);
                const now = new Date();
                const time = now.toLocaleTimeString('es-PE', { hour:'2-digit', minute:'2-digit' });
                const records = getRecords();
                const key = `${currentUser.username}_${getTodayKey()}`;
                
                // Inicializar historial de ubicaciones
                locationHistory = [loc];
                pathCoordinates = [[loc.latitude, loc.longitude]];
                
                todayRecord = { 
                    username: currentUser.username, 
                    fullName: currentUser.fullName, 
                    date: getTodayKey(), 
                    entryTime: time, 
                    entryLoc: loc, 
                    exitTime: null, 
                    exitLoc: null, 
                    noWork: false,
                    locationHistory: locationHistory,
                    lastLocation: loc
                };
                records[key] = todayRecord;
                saveRecords(records);
                
                // Mostrar panel de ubicaciÃ³n
                document.getElementById('geoInfo').style.display = 'block';
                
                // â­ INICIALIZAR MAPA EN VIVO
                setTimeout(() => {
                    initEmployeeMap(loc.latitude, loc.longitude);
                }, 300);
                
                // â­ INICIAR TRACKING CONTINUO
                startLocationTracking();
                
                updateUI();
                sendBrowserNotification('ğŸŸ¢ Entrada Registrada', currentUser.fullName + ' marcÃ³ ENTRADA a las ' + time);
                
                const precisionMsg = loc.accuracy <= 50 ? 'ğŸ“ PrecisiÃ³n: ' + Math.round(loc.accuracy) + 'm âœ…' : 'ğŸ“ PrecisiÃ³n: ' + Math.round(loc.accuracy) + 'm âš ï¸';
                notify('âœ… Entrada: ' + time + ' | MAPA EN VIVO ACTIVADO ğŸ—ºï¸');
            } catch(e) { notify('âŒ ' + e.message, 'error'); document.getElementById('btnEntry').disabled = false; }
            document.getElementById('btnEntry').textContent = 'ğŸŸ¢ MARCAR ENTRADA';
        }
        async function markExit() {
            try {
                document.getElementById('btnExit').disabled = true;
                document.getElementById('btnExit').textContent = 'ğŸ“ Obteniendo ubicaciÃ³n...';
                const loc = await getPosition();
                
                // Advertencia si la precisiÃ³n es mala (mayor a 50 metros)
                if (loc.accuracy > 50) {
                    notify('âš ï¸ PrecisiÃ³n baja: ' + Math.round(loc.accuracy) + 'm. Intenta estar al aire libre o activar GPS.', 'error');
                }
                
                loc.address = await getAddress(loc.latitude, loc.longitude);
                const now = new Date();
                const time = now.toLocaleTimeString('es-PE', { hour:'2-digit', minute:'2-digit' });
                const records = getRecords();
                const key = `${currentUser.username}_${getTodayKey()}`;
                
                // Agregar ubicaciÃ³n final al historial
                locationHistory.push(loc);
                
                todayRecord.exitTime = time;
                todayRecord.exitLoc = loc;
                todayRecord.locationHistory = locationHistory;
                todayRecord.lastLocation = loc;
                records[key] = todayRecord;
                saveRecords(records);
                
                // â­ DETENER TRACKING CONTINUO
                stopLocationTracking();
                
                updateUI();
                sendBrowserNotification('ğŸ”´ Salida Registrada', currentUser.fullName + ' marcÃ³ SALIDA a las ' + time);
                
                const precisionMsg = loc.accuracy <= 50 ? 'ğŸ“ PrecisiÃ³n: ' + Math.round(loc.accuracy) + 'm âœ…' : 'ğŸ“ PrecisiÃ³n: ' + Math.round(loc.accuracy) + 'm âš ï¸';
                notify('âœ… Salida: ' + time + ' | ' + precisionMsg + ' | Tracking detenido');
            } catch(e) { notify('âŒ ' + e.message, 'error'); document.getElementById('btnExit').disabled = false; }
            document.getElementById('btnExit').textContent = 'ğŸ”´ MARCAR SALIDA';
        }
        function showNoWorkForm() {
            document.getElementById('noWorkForm').style.display = 'block';
            document.getElementById('noWorkType').value = '';
            document.getElementById('noWorkDetail').value = '';
            document.getElementById('btnNoWork').disabled = true;
        }
        function confirmNoWork() {
            const type = document.getElementById('noWorkType').value;
            const detail = document.getElementById('noWorkDetail').value.trim();
            
            // Validaciones
            if(!type) { 
                notify('âŒ Debe seleccionar el tipo de ausencia', 'error'); 
                return; 
            }
            if(!detail || detail.length < 10) { 
                notify('âŒ La descripciÃ³n debe tener al menos 10 caracteres', 'error'); 
                return; 
            }
            
            // ConfirmaciÃ³n final
            if(!confirm(`Â¿Confirmar ausencia por "${type}"?\n\nDescripciÃ³n: ${detail}\n\nEsta acciÃ³n quedarÃ¡ registrada.`)) {
                return;
            }
            
            const records = getRecords();
            const key = `${currentUser.username}_${getTodayKey()}`;
            todayRecord = { 
                username: currentUser.username, 
                fullName: currentUser.fullName, 
                date: getTodayKey(), 
                noWork: true, 
                noWorkType: type, 
                noWorkDetail: detail,
                registeredAt: new Date().toISOString()
            };
            records[key] = todayRecord;
            saveRecords(records);
            document.getElementById('noWorkForm').style.display = 'none';
            document.getElementById('btnNoWork').disabled = true;
            updateUI();
            notify('âœ… Ausencia registrada correctamente');
        }
        function cancelNoWork() { 
            document.getElementById('noWorkForm').style.display = 'none'; 
            document.getElementById('btnNoWork').disabled = false;
            document.getElementById('noWorkType').value = '';
            document.getElementById('noWorkDetail').value = '';
        }

        // EMPLOYEE HISTORY
        function initHistoryFilter() {
            const sel = document.getElementById('historyMonth');
            const now = new Date();
            let opts = '';
            for(let i=0; i<12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                opts += `<option value="${d.getFullYear()}-${d.getMonth()}" ${i===0?'selected':''}>${getMonthName(d.getMonth())} ${d.getFullYear()}</option>`;
            }
            sel.innerHTML = opts;
            loadHistory();
        }
        
        // FunciÃ³n para calcular tardanza
        function checkTardiness(entryTime, scheduleEntry, tolerance) {
            if (!entryTime || !scheduleEntry) return { late: false, minutes: 0 };
            const [eH, eM] = entryTime.split(':').map(Number);
            const [sH, sM] = scheduleEntry.split(':').map(Number);
            const entryMinutes = eH * 60 + eM;
            const scheduleMinutes = sH * 60 + sM;
            const diff = entryMinutes - scheduleMinutes;
            const tol = tolerance || 15;
            return {
                late: diff > tol,
                minutes: diff > 0 ? diff : 0
            };
        }
        
        function loadHistory() {
            const [year, month] = document.getElementById('historyMonth').value.split('-').map(Number);
            const cfg = currentUser.config;
            const records = getRecords();
            const days = new Date(year, month+1, 0).getDate();
            const today = new Date();
            let html = '';
            for(let day=1; day<=days; day++) {
                const date = new Date(year, month, day);
                const dow = date.getDay();
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                const key = `${currentUser.username}_${dateKey}`;
                const rec = records[key];
                const future = date > today;
                const isWork = cfg.workDays.includes(dow);
                let entry='-', exit='-', hours='-', status='', badge='badge-muted', detail='-', punctuality='-';
                if(future) { status='ğŸ“… Pendiente'; }
                else if(!isWork && !rec) { status='ğŸ–ï¸ Descanso'; }
                else if(rec) {
                    if(rec.noWork) { 
                        status='ğŸš« '+rec.noWorkType; 
                        badge='badge-warning'; 
                        detail = rec.noWorkDetail ? `<span title="${rec.noWorkDetail}" style="cursor:help;color:var(--warning-color);">ğŸ“ ${rec.noWorkDetail.substring(0,20)}${rec.noWorkDetail.length > 20 ? '...' : ''}</span>` : '-';
                    }
                    else {
                        entry = rec.entryTime || '-';
                        exit = rec.exitTime || '-';
                        
                        // Verificar tardanza
                        const tardiness = checkTardiness(rec.entryTime, cfg.scheduleEntry || '08:00', cfg.tolerance || 15);
                        if (rec.entryTime) {
                            if (tardiness.late) {
                                punctuality = `<span class="badge badge-danger">â° Tarde ${tardiness.minutes} min</span>`;
                            } else {
                                punctuality = `<span class="badge badge-success">âœ… Puntual</span>`;
                            }
                        }
                        
                        if(rec.entryTime && rec.exitTime) {
                            const [eH,eM] = rec.entryTime.split(':').map(Number);
                            const [xH,xM] = rec.exitTime.split(':').map(Number);
                            hours = formatHours((xH+xM/60)-(eH+eM/60));
                            status='âœ… OK'; badge='badge-success';
                        } else { status='âš ï¸ Incompleto'; badge='badge-warning'; }
                    }
                } else if(isWork) { status='âŒ Falta'; badge='badge-danger'; }
                html += `<tr style="${future?'opacity:0.5':''}"><td>${day}/${month+1} (${getDayName(dow)})</td><td>${entry}</td><td>${exit}</td><td>${hours}</td><td><span class="badge ${badge}">${status}</span></td><td>${punctuality}</td><td>${detail}</td></tr>`;
            }
            document.getElementById('historyTable').innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--text-muted)">Sin registros</td></tr>';
        }

        // ADMIN FUNCTIONS
        function initAdmin() {
            document.getElementById('adminUserName').textContent = currentUser.fullName;
            loadEmpTable();
            refreshStatus();
            initAdminFilters();
            setTimeout(() => { if(!adminMap) initAdminMap(); }, 500);
        }
        function showTab(id, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'tabMap' && adminMap) { setTimeout(() => { adminMap.invalidateSize(); loadMapMarkers(); }, 100); }
        }
        function refreshStatus() {
            const emps = getEmployees();
            const records = getRecords();
            const todayKey = getTodayKey();
            let working=0, finished=0, absent=0;
            let html = '';
            emps.forEach(emp => {
                const key = `${emp.username}_${todayKey}`;
                const rec = records[key];
                let statusClass='absent', badge='<span class="badge badge-danger">ğŸ”´ Sin marcar</span>', timeInfo='--:--', locInfo='Sin ubicaciÃ³n';
                if(rec) {
                    if(rec.noWork) { badge=`<span class="badge badge-warning">ğŸš« ${rec.noWorkType}</span>`; absent++; }
                    else if(rec.entryTime && rec.exitTime) {
                        statusClass='finished'; badge='<span class="badge badge-success">âœ… Finalizado</span>';
                        timeInfo = `${rec.entryTime} - ${rec.exitTime}`; finished++;
                        if(rec.exitLoc) locInfo = rec.exitLoc.address ? rec.exitLoc.address.substring(0,35)+'...' : `${rec.exitLoc.latitude.toFixed(4)}, ${rec.exitLoc.longitude.toFixed(4)}`;
                    } else if(rec.entryTime) {
                        statusClass='working'; badge='<span class="badge badge-success">ğŸŸ¢ Trabajando</span>';
                        timeInfo = `Entrada: ${rec.entryTime}`; working++;
                        if(rec.entryLoc) locInfo = rec.entryLoc.address ? rec.entryLoc.address.substring(0,35)+'...' : `${rec.entryLoc.latitude.toFixed(4)}, ${rec.entryLoc.longitude.toFixed(4)}`;
                    }
                } else { absent++; }
                const initials = emp.fullName.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                let locBtn = '';
                if(rec && rec.entryLoc) locBtn = `<button class="btn btn-primary btn-sm" style="margin-top:8px;" onclick="showLoc(${rec.entryLoc.latitude},${rec.entryLoc.longitude},'${(rec.entryLoc.address||'').replace(/'/g,"\\'")}')">ğŸ“ Ver Mapa</button>`;
                html += `<div class="emp-card ${statusClass}">
                    <div class="emp-info"><div class="emp-avatar">${initials}</div><div class="emp-details"><h4>${emp.fullName}</h4><p>@${emp.username}</p></div></div>
                    <div style="text-align:center;">${badge}</div>
                    <div style="text-align:right;"><div style="font-family:'JetBrains Mono',monospace;font-weight:600;">${timeInfo}</div><div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px;">${locInfo}</div>${locBtn}</div>
                </div>`;
            });
            document.getElementById('empStatusList').innerHTML = html || '<p style="text-align:center;color:var(--text-muted);padding:30px;">No hay empleados</p>';
            document.getElementById('countWorking').textContent = working;
            document.getElementById('countFinished').textContent = finished;
            document.getElementById('countAbsent').textContent = absent;
            document.getElementById('countTotal').textContent = emps.length;
        }
        // EMPLOYEE TABLE WITH EDIT AND DETAIL BUTTONS
        function loadEmpTable() {
            const emps = getEmployees();
            let html = '';
            emps.forEach(emp => {
                const daysNames = emp.config.workDays.map(d => getDayName(d)).join(', ');
                html += `<tr>
                    <td><strong>${emp.username}</strong></td>
                    <td>${emp.fullName}</td>
                    <td>${emp.email || '-'}</td>
                    <td>${emp.config.dailyHours}h</td>
                    <td>${formatMoney(emp.config.monthlySalary)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="showEmpDetail('${emp.username}')" title="Ver detalle">ğŸ“Š</button>
                            <button class="btn btn-warning btn-sm" onclick="editEmp('${emp.username}')" title="Editar">âœï¸</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteEmp('${emp.username}')" title="Eliminar">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>`;
            });
            document.getElementById('empTable').innerHTML = html || '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text-muted)">No hay empleados</td></tr>';
        }

        // ADD EMPLOYEE MODAL
        function showAddEmpModal() {
            document.getElementById('empModalTitle').textContent = 'â• Agregar Empleado';
            document.getElementById('editingEmpUser').value = '';
            document.getElementById('newEmpUser').value = '';
            document.getElementById('newEmpUser').disabled = false;
            document.getElementById('newEmpName').value = '';
            document.getElementById('newEmpEmail').value = '';
            document.getElementById('newEmpPass').value = '';
            document.getElementById('newEmpPass').required = true;
            document.getElementById('newEmpPass').placeholder = 'ContraseÃ±a';
            document.getElementById('newEmpHours').value = '8';
            document.getElementById('newEmpSalary').value = '1500';
            document.getElementById('newEmpEntryTime').value = '08:00';
            document.getElementById('newEmpExitTime').value = '17:00';
            document.getElementById('newEmpTolerance').value = '15';
            document.querySelectorAll('input[name="workDays"]').forEach(cb => {
                cb.checked = [1,2,3,4,5].includes(parseInt(cb.value));
            });
            document.getElementById('empModal').classList.add('show');
        }

        // EDIT EMPLOYEE
        function editEmp(username) {
            const users = getUsers();
            const emp = users[username];
            if(!emp) return;
            
            document.getElementById('empModalTitle').textContent = 'âœï¸ Editar Empleado';
            document.getElementById('editingEmpUser').value = username;
            document.getElementById('newEmpUser').value = emp.username;
            document.getElementById('newEmpUser').disabled = true;
            document.getElementById('newEmpName').value = emp.fullName;
            document.getElementById('newEmpEmail').value = emp.email || '';
            document.getElementById('newEmpPass').value = '';
            document.getElementById('newEmpPass').required = false;
            document.getElementById('newEmpPass').placeholder = 'Dejar vacÃ­o para no cambiar';
            document.getElementById('newEmpHours').value = emp.config.dailyHours;
            document.getElementById('newEmpSalary').value = emp.config.monthlySalary;
            document.getElementById('newEmpEntryTime').value = emp.config.scheduleEntry || '08:00';
            document.getElementById('newEmpExitTime').value = emp.config.scheduleExit || '17:00';
            document.getElementById('newEmpTolerance').value = emp.config.tolerance || 15;
            document.querySelectorAll('input[name="workDays"]').forEach(cb => {
                cb.checked = emp.config.workDays.includes(parseInt(cb.value));
            });
            document.getElementById('empModal').classList.add('show');
        }

        function closeEmpModal() { 
            document.getElementById('empModal').classList.remove('show'); 
            document.getElementById('empForm').reset();
            document.getElementById('newEmpUser').disabled = false;
        }

        document.getElementById('empForm').addEventListener('submit', e => {
            e.preventDefault();
            const users = getUsers();
            const editingUser = document.getElementById('editingEmpUser').value;
            const username = document.getElementById('newEmpUser').value.trim().toLowerCase();
            const password = document.getElementById('newEmpPass').value;
            const workDays = Array.from(document.querySelectorAll('input[name="workDays"]:checked')).map(c => parseInt(c.value));
            const scheduleEntry = document.getElementById('newEmpEntryTime').value;
            const scheduleExit = document.getElementById('newEmpExitTime').value;
            const tolerance = parseInt(document.getElementById('newEmpTolerance').value) || 15;
            
            if(!editingUser && users[username]) { 
                notify('âŒ Usuario ya existe', 'error'); 
                return; 
            }
            
            if(editingUser) {
                // Editing existing employee
                users[editingUser].fullName = document.getElementById('newEmpName').value;
                users[editingUser].email = document.getElementById('newEmpEmail').value;
                if(password) users[editingUser].password = password;
                users[editingUser].config.dailyHours = parseInt(document.getElementById('newEmpHours').value);
                users[editingUser].config.monthlySalary = parseFloat(document.getElementById('newEmpSalary').value);
                users[editingUser].config.workDays = workDays;
                users[editingUser].config.scheduleEntry = scheduleEntry;
                users[editingUser].config.scheduleExit = scheduleExit;
                users[editingUser].config.tolerance = tolerance;
                notify('âœ… Empleado actualizado');
            } else {
                // Adding new employee
                users[username] = {
                    username,
                    password: password,
                    fullName: document.getElementById('newEmpName').value,
                    email: document.getElementById('newEmpEmail').value,
                    role: 'employee',
                    companyId: currentUser.companyId,
                    active: true,
                    config: {
                        dailyHours: parseInt(document.getElementById('newEmpHours').value),
                        monthlySalary: parseFloat(document.getElementById('newEmpSalary').value),
                        workDays,
                        scheduleEntry,
                        scheduleExit,
                        tolerance
                    }
                };
                notify('âœ… Empleado agregado');
            }
            
            saveUsers(users);
            closeEmpModal();
            loadEmpTable();
            refreshStatus();
            updateAdminEmpFilter();
        });

        let deleteTargetUser = null;

        function deleteEmp(username) {
            const users = getUsers();
            const emp = users[username];
            if(!emp) return;
            
            deleteTargetUser = username;
            document.getElementById('deleteEmpName').textContent = emp.fullName;
            document.getElementById('deleteEmpUser').textContent = username;
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
            document.getElementById('deleteModal').classList.add('show');
            
            // Agregar evento para validar el input
            document.getElementById('deleteConfirmInput').oninput = function() {
                const isValid = this.value.trim().toLowerCase() === username.toLowerCase();
                document.getElementById('confirmDeleteBtn').disabled = !isValid;
            };
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteTargetUser = null;
        }

        function confirmDeleteEmp() {
            if(!deleteTargetUser) return;
            
            const users = getUsers();
            delete users[deleteTargetUser];
            saveUsers(users);
            
            closeDeleteModal();
            loadEmpTable();
            refreshStatus();
            updateAdminEmpFilter();
            notify('âœ… Empleado eliminado correctamente');
        }

        // EMPLOYEE DETAIL MODAL
        let currentDetailEmployee = null;
        
        function showEmpDetail(username) {
            currentDetailEmployee = username;
            const users = getUsers();
            const emp = users[username];
            if(!emp) return;
            
            // Inicializar filtro de mes
            const select = document.getElementById('detailMonthFilter');
            const now = new Date();
            select.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const val = `${d.getFullYear()}-${d.getMonth()}`;
                const text = `${getMonthName(d.getMonth())} ${d.getFullYear()}`;
                select.innerHTML += `<option value="${val}">${text}</option>`;
            }
            
            // Mostrar header del empleado
            const cfg = emp.config;
            const initials = emp.fullName.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
            const workDaysNames = cfg.workDays.map(d => getDayName(d)).join(', ');
            const workDaysPerMonth = 22;
            const hourlyRate = cfg.monthlySalary / (workDaysPerMonth * cfg.dailyHours);
            
            document.getElementById('detailModalHeader').innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">${initials}</div>
                    <div class="profile-info">
                        <h2>${emp.fullName}</h2>
                        <p>@${emp.username} | ${emp.email || 'Sin email'}</p>
                    </div>
                </div>
                <div class="info-grid" style="margin-top:15px;">
                    <div class="info-box"><div class="info-label">ğŸ’µ Sueldo Base</div><div class="info-value" style="font-size:1rem;">${formatMoney(cfg.monthlySalary)}</div></div>
                    <div class="info-box"><div class="info-label">â° Horas/DÃ­a</div><div class="info-value">${cfg.dailyHours}h</div></div>
                    <div class="info-box"><div class="info-label">ğŸ’° Valor/Hora</div><div class="info-value" style="font-size:1rem;">${formatMoney(hourlyRate)}</div></div>
                    <div class="info-box"><div class="info-label">ğŸ“… DÃ­as Laborales</div><div class="info-value" style="font-size:0.7rem;">${workDaysNames}</div></div>
                </div>
            `;
            
            document.getElementById('detailModal').classList.add('show');
            updateDetailModal();
        }
        
        function updateDetailModal() {
            if (!currentDetailEmployee) return;
            
            const users = getUsers();
            const emp = users[currentDetailEmployee];
            if(!emp) return;
            
            const [year, month] = document.getElementById('detailMonthFilter').value.split('-').map(Number);
            const records = getRecords();
            const cfg = emp.config;
            const now = new Date();
            
            // Calculate monthly stats
            let totalHours = 0;
            let normalHours = 0;
            let extraHours = 0;
            let daysWorked = 0;
            let daysAbsent = 0;
            let daysNoWork = 0;
            let monthRecords = [];
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dailyHours = cfg.dailyHours || 8;
            
            for(let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                if(date > now) continue;
                
                const dow = date.getDay();
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                const key = `${currentDetailEmployee}_${dateKey}`;
                const rec = records[key];
                const isWorkDay = cfg.workDays.includes(dow);
                
                if(rec && !rec.noWork && rec.entryTime && rec.exitTime) {
                    const [eH, eM] = rec.entryTime.split(':').map(Number);
                    const [xH, xM] = rec.exitTime.split(':').map(Number);
                    const worked = (xH + xM/60) - (eH + eM/60);
                    totalHours += worked;
                    
                    if(worked > dailyHours) {
                        normalHours += dailyHours;
                        extraHours += (worked - dailyHours);
                    } else {
                        normalHours += worked;
                    }
                    daysWorked++;
                    monthRecords.push({ day, date: dateKey, dow, ...rec, workedHours: worked });
                } else if(rec && rec.noWork) {
                    daysNoWork++;
                    monthRecords.push({ day, date: dateKey, dow, ...rec });
                } else if(isWorkDay && !rec) {
                    daysAbsent++;
                    monthRecords.push({ day, date: dateKey, dow, absent: true });
                }
            }
            
            // Calculate payment (hora extra = mismo valor que hora normal)
            const workDaysPerMonth = 22;
            const hourlySalary = cfg.monthlySalary / (workDaysPerMonth * dailyHours);
            const extraPay = extraHours * hourlySalary; // Sin multiplicador
            const deductions = daysAbsent * (cfg.monthlySalary / 30);
            const basePay = (daysWorked / workDaysPerMonth) * cfg.monthlySalary;
            const totalPay = basePay + extraPay;
            const netPay = cfg.monthlySalary + extraPay - deductions;
            
            let html = `
                <div class="detail-section">
                    <h3>ğŸ“Š Resumen de ${getMonthName(month)} ${year}</h3>
                    <div class="info-grid" style="margin-bottom:20px;">
                        <div class="stat-card success" style="text-align:center;">
                            <div class="info-label">âœ… DÃ­as Trabajados</div>
                            <div class="stat-value" style="color:var(--success-color)">${daysWorked}</div>
                        </div>
                        <div class="stat-card danger" style="text-align:center;">
                            <div class="info-label">âŒ Faltas</div>
                            <div class="stat-value" style="color:var(--danger-color)">${daysAbsent}</div>
                        </div>
                        <div class="stat-card warning" style="text-align:center;">
                            <div class="info-label">ğŸš« Permisos</div>
                            <div class="stat-value" style="color:var(--warning-color)">${daysNoWork}</div>
                        </div>
                        <div class="stat-card" style="text-align:center;">
                            <div class="info-label">â±ï¸ Horas Normales</div>
                            <div class="stat-value">${normalHours.toFixed(1)}h</div>
                        </div>
                        <div class="stat-card warning" style="text-align:center;">
                            <div class="info-label">ğŸ”¥ Horas Extra</div>
                            <div class="stat-value" style="color:var(--warning-color)">${extraHours.toFixed(1)}h</div>
                        </div>
                        <div class="stat-card" style="text-align:center;">
                            <div class="info-label">â° Total Horas</div>
                            <div class="stat-value">${totalHours.toFixed(1)}h</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>ğŸ’° CÃ¡lculo de Pago - ${getMonthName(month)} ${year}</h3>
                    <div class="stat-card" style="background:linear-gradient(135deg,rgba(37,99,235,0.1),rgba(37,99,235,0.05));border-color:rgba(37,99,235,0.3);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--card-border);">
                            <span>ğŸ’µ Sueldo Base Mensual:</span>
                            <span style="font-family:'JetBrains Mono',monospace;font-weight:600;">${formatMoney(cfg.monthlySalary)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span>ğŸ’° Valor por Hora:</span>
                            <span style="font-family:'JetBrains Mono',monospace;">${formatMoney(hourlySalary)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;color:var(--success-color);">
                            <span>ğŸ”¥ + Horas Extra (${extraHours.toFixed(1)}h Ã— ${formatMoney(hourlySalary)}):</span>
                            <span style="font-family:'JetBrains Mono',monospace;">+ ${formatMoney(extraPay)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:15px;color:var(--danger-color);">
                            <span>âŒ - Descuentos por Faltas (${daysAbsent} dÃ­as):</span>
                            <span style="font-family:'JetBrains Mono',monospace;">- ${formatMoney(deductions)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:15px;background:rgba(16,185,129,0.1);border-radius:10px;border:2px solid var(--success-color);">
                            <span style="font-weight:700;font-size:1.2rem;">ğŸ’ TOTAL NETO:</span>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--success-color);">${formatMoney(netPay)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>ğŸ“‹ Historial Detallado del Mes</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>DÃ­a</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>H.Extra</th><th>Valor Extra</th><th>Estado</th></tr></thead>
                            <tbody>`;
            
            if(monthRecords.length === 0) {
                html += '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text-muted)">Sin registros este mes</td></tr>';
            } else {
                monthRecords.sort((a,b) => b.day - a.day).forEach(rec => {
                    const extra = rec.workedHours ? Math.max(0, rec.workedHours - dailyHours) : 0;
                    const extraValue = extra * hourlySalary; // Sin multiplicador
                    let status = '', badge = 'badge-muted';
                    
                    if(rec.absent) {
                        status = 'âŒ Falta';
                        badge = 'badge-danger';
                    } else if(rec.noWork) {
                        status = 'ğŸš« ' + rec.noWorkType;
                        badge = 'badge-warning';
                    } else if(rec.entryTime && rec.exitTime) {
                        status = 'âœ… OK';
                        badge = 'badge-success';
                    } else {
                        status = 'âš ï¸ Incompleto';
                        badge = 'badge-warning';
                    }
                    
                    html += `<tr>
                        <td><strong>${rec.day}</strong>/${month+1} (${getDayName(rec.dow)})</td>
                        <td>${rec.entryTime || '-'}</td>
                        <td>${rec.exitTime || '-'}</td>
                        <td>${rec.workedHours ? rec.workedHours.toFixed(1) + 'h' : '-'}</td>
                        <td style="color:${extra > 0 ? 'var(--warning-color)' : 'var(--text-muted)'}; font-weight:${extra > 0 ? '600' : '400'}">${extra > 0 ? '+' + extra.toFixed(1) + 'h' : '-'}</td>
                        <td style="color:${extraValue > 0 ? 'var(--success-color)' : 'var(--text-muted)'}">${extraValue > 0 ? '+' + formatMoney(extraValue) : '-'}</td>
                        <td><span class="badge ${badge}">${status}</span></td>
                    </tr>`;
                });
            }
            
            html += `</tbody></table></div></div>`;
            
            document.getElementById('detailModalContent').innerHTML = html;
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
            currentDetailEmployee = null;
        }

        // ADMIN HISTORY
        function initAdminFilters() {
            updateAdminEmpFilter();
            const sel = document.getElementById('adminMonthFilter');
            const now = new Date();
            let opts = '';
            for(let i=0; i<12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                opts += `<option value="${d.getFullYear()}-${d.getMonth()}" ${i===0?'selected':''}>${getMonthName(d.getMonth())} ${d.getFullYear()}</option>`;
            }
            sel.innerHTML = opts;
            loadAdminHistory();
        }
        function updateAdminEmpFilter() {
            const sel = document.getElementById('adminEmpFilter');
            const emps = getEmployees();
            let opts = '<option value="all">Todos</option>';
            emps.forEach(e => { opts += `<option value="${e.username}">${e.fullName}</option>`; });
            sel.innerHTML = opts;
        }
        function loadAdminHistory() {
            const empFilter = document.getElementById('adminEmpFilter').value;
            const [year, month] = document.getElementById('adminMonthFilter').value.split('-').map(Number);
            const emps = getEmployees();
            const records = getRecords();
            const days = new Date(year, month+1, 0).getDate();
            const today = new Date();
            let html = '';
            const filteredEmps = empFilter === 'all' ? emps : emps.filter(e => e.username === empFilter);
            filteredEmps.forEach(emp => {
                const cfg = emp.config;
                for(let day=1; day<=days; day++) {
                    const date = new Date(year, month, day);
                    if(date > today) continue;
                    const dow = date.getDay();
                    const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                    const key = `${emp.username}_${dateKey}`;
                    const rec = records[key];
                    const isWork = cfg.workDays.includes(dow);
                    let entry='-', exit='-', hours='-', status='', badge='badge-muted', detail='-', punctuality='-';
                    if(!isWork && !rec) { status='ğŸ–ï¸ Descanso'; }
                    else if(rec) {
                        if(rec.noWork) { 
                            status='ğŸš« '+rec.noWorkType; 
                            badge='badge-warning'; 
                            detail = rec.noWorkDetail ? `<span title="${rec.noWorkDetail}" style="cursor:help;color:var(--warning-color);">ğŸ“ ${rec.noWorkDetail.substring(0,25)}${rec.noWorkDetail.length > 25 ? '...' : ''}</span>` : '-';
                        }
                        else {
                            entry = rec.entryTime || '-';
                            exit = rec.exitTime || '-';
                            
                            // Verificar tardanza
                            const tardiness = checkTardiness(rec.entryTime, cfg.scheduleEntry || '08:00', cfg.tolerance || 15);
                            if (rec.entryTime) {
                                if (tardiness.late) {
                                    punctuality = `<span class="badge badge-danger">â° ${tardiness.minutes} min</span>`;
                                } else {
                                    punctuality = `<span class="badge badge-success">âœ…</span>`;
                                }
                            }
                            
                            if(rec.entryTime && rec.exitTime) {
                                const [eH,eM] = rec.entryTime.split(':').map(Number);
                                const [xH,xM] = rec.exitTime.split(':').map(Number);
                                hours = formatHours((xH+xM/60)-(eH+eM/60));
                                status='âœ… OK'; badge='badge-success';
                            } else { status='âš ï¸ Incompleto'; badge='badge-warning'; }
                        }
                    } else if(isWork) { status='âŒ Falta'; badge='badge-danger'; }
                    if(status) html += `<tr><td>${emp.fullName}</td><td>${day}/${month+1} (${getDayName(dow)})</td><td>${entry}</td><td>${exit}</td><td>${hours}</td><td>${punctuality}</td><td><span class="badge ${badge}">${status}</span></td><td>${detail}</td></tr>`;
                }
            });
            document.getElementById('adminHistoryTable').innerHTML = html || '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-muted)">Sin registros</td></tr>';
        }

        // MAP FUNCTIONS
        let polylines = []; // Para guardar las lÃ­neas del recorrido
        
        function initAdminMap() {
            adminMap = L.map('adminMap').setView([-12.0464, -77.0428], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(adminMap);
            loadMapMarkers();
            
            // Actualizar mapa cada 30 segundos para ver ubicaciones en vivo
            setInterval(loadMapMarkers, 30000);
        }
        function loadMapMarkers() {
            if(!adminMap) return;
            
            // Limpiar marcadores y lÃ­neas existentes
            adminMap.eachLayer(layer => { 
                if(layer instanceof L.Marker || layer instanceof L.Polyline) {
                    adminMap.removeLayer(layer); 
                }
            });
            
            const emps = getEmployees();
            const records = getRecords();
            const todayKey = getTodayKey();
            const bounds = [];
            
            emps.forEach(emp => {
                const key = `${emp.username}_${todayKey}`;
                const rec = records[key];
                
                if(rec && rec.entryLoc) {
                    // Marcador de entrada
                    const greenIcon = L.divIcon({ className:'', html:`<div style="background:#10b981;color:white;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:bold;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.3);">ğŸŸ¢ ${emp.fullName}</div>`, iconSize:[120,30] });
                    L.marker([rec.entryLoc.latitude, rec.entryLoc.longitude], {icon:greenIcon})
                        .addTo(adminMap)
                        .bindPopup(`<b>${emp.fullName}</b><br>Entrada: ${rec.entryTime}<br><small>${rec.entryLoc.address||'Sin direcciÃ³n'}</small>`);
                    bounds.push([rec.entryLoc.latitude, rec.entryLoc.longitude]);
                    
                    // Si tiene historial de ubicaciones, dibujar recorrido
                    if(rec.locationHistory && rec.locationHistory.length > 1) {
                        const routePoints = rec.locationHistory.map(loc => [loc.latitude, loc.longitude]);
                        const polyline = L.polyline(routePoints, {
                            color: '#3b82f6',
                            weight: 3,
                            opacity: 0.7,
                            dashArray: '10, 10'
                        }).addTo(adminMap);
                        
                        // Agregar marcadores pequeÃ±os en cada punto del historial
                        rec.locationHistory.forEach((loc, idx) => {
                            if(idx > 0 && idx < rec.locationHistory.length - 1) {
                                const time = loc.timestamp ? new Date(loc.timestamp).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : '--:--';
                                const dotIcon = L.divIcon({ 
                                    className:'', 
                                    html:`<div style="background:#3b82f6;width:10px;height:10px;border-radius:50%;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`, 
                                    iconSize:[10,10] 
                                });
                                L.marker([loc.latitude, loc.longitude], {icon:dotIcon})
                                    .addTo(adminMap)
                                    .bindPopup(`<small>ğŸ“ ${time}<br>${loc.address || 'Sin direcciÃ³n'}</small>`);
                            }
                        });
                    }
                    
                    // Mostrar Ãºltima ubicaciÃ³n conocida (en vivo) si aÃºn no marcÃ³ salida
                    if(rec.lastLocation && !rec.exitTime) {
                        const lastTime = rec.lastLocation.timestamp ? new Date(rec.lastLocation.timestamp).toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'}) : 'Ahora';
                        const liveIcon = L.divIcon({ 
                            className:'', 
                            html:`<div style="background:#f59e0b;color:white;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:bold;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.3);animation:pulse 2s infinite;">ğŸ”´ EN VIVO - ${emp.fullName}</div>
                            <style>@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}</style>`, 
                            iconSize:[150,30] 
                        });
                        const accuracy = rec.lastLocation.accuracy ? rec.lastLocation.accuracy.toFixed(0) : '?';
                        L.marker([rec.lastLocation.latitude, rec.lastLocation.longitude], {icon:liveIcon})
                            .addTo(adminMap)
                            .bindPopup(`<b>ğŸ”´ ${emp.fullName} - EN VIVO</b><br>Ãšltima actualizaciÃ³n: ${lastTime}<br>PrecisiÃ³n: ${accuracy}m<br><small>${rec.lastLocation.address||'Sin direcciÃ³n'}</small>`);
                        bounds.push([rec.lastLocation.latitude, rec.lastLocation.longitude]);
                    }
                }
                
                if(rec && rec.exitLoc) {
                    const redIcon = L.divIcon({ className:'', html:`<div style="background:#ef4444;color:white;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:bold;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.3);">ğŸ”´ ${emp.fullName}</div>`, iconSize:[120,30] });
                    L.marker([rec.exitLoc.latitude, rec.exitLoc.longitude], {icon:redIcon})
                        .addTo(adminMap)
                        .bindPopup(`<b>${emp.fullName}</b><br>Salida: ${rec.exitTime}<br><small>${rec.exitLoc.address||'Sin direcciÃ³n'}</small>`);
                    bounds.push([rec.exitLoc.latitude, rec.exitLoc.longitude]);
                }
            });
            
            if(bounds.length > 0) adminMap.fitBounds(bounds, {padding:[50,50]});
        }
        function showLoc(lat, lng, address) {
            document.getElementById('locModal').classList.add('show');
            document.getElementById('locModalInfo').innerHTML = `
                <div style="background:rgba(37,99,235,0.1);padding:15px;border-radius:10px;margin-bottom:15px;">
                    <p style="margin-bottom:8px;"><strong>ğŸ“ Coordenadas:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                    <p><strong>ğŸ  DirecciÃ³n:</strong> ${address || 'No disponible'}</p>
                </div>`;
            setTimeout(() => {
                if(locMap) { locMap.remove(); }
                locMap = L.map('locationMap').setView([lat, lng], 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(locMap);
                L.marker([lat, lng]).addTo(locMap).bindPopup(address || 'UbicaciÃ³n').openPopup();
            }, 100);
        }
        function closeLocModal() { document.getElementById('locModal').classList.remove('show'); if(locMap) { locMap.remove(); locMap = null; } }

        // ========== SUPER ADMIN FUNCTIONS ==========
        function initSuperAdmin() {
            loadSuperStats();
            loadSuperCompanyList();
        }
        function showSuperTab(id, btn) {
            document.querySelectorAll('#superAdminScreen .tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#superAdminScreen .tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }
        function loadSuperStats() {
            const companies = Object.values(getCompanies());
            document.getElementById('superTotalCompanies').textContent = companies.length;
            document.getElementById('superPendingCompanies').textContent = companies.filter(c => c.status === 'pending').length;
            document.getElementById('superApprovedCompanies').textContent = companies.filter(c => c.status === 'approved').length;
            document.getElementById('superSuspendedCompanies').textContent = companies.filter(c => c.status === 'suspended').length;
        }
        function loadSuperCompanyList() {
            const companies = Object.values(getCompanies());
            const users = getUsers();
            const planNames = {free:'Gratuito',basic:'BÃ¡sico',pro:'Profesional',enterprise:'Empresarial'};
            let html = '';
            companies.forEach(company => {
                const empCount = Object.values(users).filter(u => u.companyId === company.id && u.role === 'employee').length;
                const statusBadge = company.status === 'approved' ? '<span class="badge badge-success">âœ… Aprobada</span>' :
                                    (company.status === 'pending' ? '<span class="badge badge-warning">â³ Pendiente</span>' :
                                    '<span class="badge badge-danger">ğŸš« Suspendida</span>');
                html += `<div class="emp-card" style="border-color:${company.status==='approved'?'var(--success-color)':(company.status==='pending'?'var(--warning-color)':'var(--danger-color)')}">
                    <div class="emp-info">
                        <div class="emp-avatar">ğŸ¢</div>
                        <div class="emp-details"><h4>${company.name}</h4><p>RUC: ${company.ruc || 'N/A'}</p></div>
                    </div>
                    <div style="text-align:center;">${statusBadge}<br><small style="color:var(--text-muted);">${planNames[company.plan]||company.plan}</small></div>
                    <div style="text-align:right;">
                        <div style="font-family:'JetBrains Mono',monospace;font-weight:600;">${empCount}/${company.maxEmployees}</div>
                        <small style="color:var(--text-muted);">empleados</small><br>
                        <button class="btn btn-primary btn-sm" style="margin-top:8px;" onclick="showConfigCompanyModal('${company.id}')">âš™ï¸ Configurar</button>
                    </div>
                </div>`;
            });
            document.getElementById('superCompanyList').innerHTML = html || '<p style="text-align:center;color:var(--text-muted);padding:30px;">No hay empresas</p>';
        }
        function showConfigCompanyModal(companyId) {
            const companies = getCompanies();
            const company = companies[companyId];
            if(!company) return;
            document.getElementById('configCompanyId').value = companyId;
            document.getElementById('configCompanyStatus').value = company.status;
            document.getElementById('configCompanyPlan').value = company.plan;
            document.getElementById('configCompanyMaxEmp').value = company.maxEmployees;
            document.getElementById('configCompanyInfo').innerHTML = `<div style="background:rgba(37,99,235,0.1);padding:15px;border-radius:10px;"><h3 style="color:var(--primary-color);">${company.name}</h3><p style="color:var(--text-muted);">RUC: ${company.ruc||'N/A'}</p></div>`;
            document.getElementById('configCompanyModal').classList.add('show');
        }
        function closeConfigCompanyModal() { document.getElementById('configCompanyModal').classList.remove('show'); }
        document.getElementById('configCompanyForm').addEventListener('submit', e => {
            e.preventDefault();
            const companyId = document.getElementById('configCompanyId').value;
            const companies = getCompanies();
            companies[companyId].status = document.getElementById('configCompanyStatus').value;
            companies[companyId].plan = document.getElementById('configCompanyPlan').value;
            companies[companyId].maxEmployees = parseInt(document.getElementById('configCompanyMaxEmp').value);
            saveCompanies(companies);
            closeConfigCompanyModal();
            loadSuperStats();
            loadSuperCompanyList();
            notify('âœ… Empresa actualizada');
        });
        document.getElementById('superRegisterForm').addEventListener('submit', e => {
            e.preventDefault();
            const companyId = 'company_' + Date.now();
            const adminUser = document.getElementById('superCompanyUser').value.trim();
            const companies = getCompanies();
            const users = getUsers();
            const planLimits = {free:5, basic:20, pro:50, enterprise:1000};
            const plan = document.getElementById('superCompanyPlan').value;
            companies[companyId] = {
                id: companyId,
                name: document.getElementById('superCompanyName').value.trim(),
                ruc: document.getElementById('superCompanyRuc').value.trim(),
                status: document.getElementById('superCompanyStatus').value,
                plan: plan,
                maxEmployees: parseInt(document.getElementById('superCompanyMaxEmp').value) || planLimits[plan],
                createdAt: new Date().toISOString()
            };
            users[adminUser] = {
                username: adminUser,
                password: document.getElementById('superCompanyPass').value,
                fullName: 'Admin ' + companies[companyId].name,
                email: document.getElementById('superCompanyEmail').value.trim(),
                role: 'admin',
                companyId: companyId,
                active: true
            };
            saveCompanies(companies);
            saveUsers(users);
            document.getElementById('superRegisterForm').reset();
            loadSuperStats();
            loadSuperCompanyList();
            notify('âœ… Empresa creada');
            // Simular notificaciÃ³n por email
            console.log('ğŸ“§ EMAIL: Nueva empresa "' + companies[companyId].name + '" registrada');
        });

        // INIT
        window.onload = function() {
            if(Object.keys(getUsers()).length === 0 || !getUsers()['superadmin']) loadDemo();
            const saved = sessionStorage.getItem('currentUser');
            if(saved) {
                currentUser = JSON.parse(saved);
                if(currentUser.role === 'superadmin') { 
                    initSuperAdmin(); 
                    showScreen('superAdminScreen'); 
                } else if(currentUser.role === 'admin' || currentUser.role === 'employee') {
                    // Verificar estado de empresa
                    const companies = getCompanies();
                    const company = companies[currentUser.companyId];
                    if (!company || company.status !== 'approved') {
                        document.getElementById('restrictedCompanyName').textContent = 'Empresa: ' + (company ? company.name : 'No asignada');
                        showScreen('restrictedScreen');
                    } else if(currentUser.role === 'admin') {
                        initAdmin();
                        showScreen('adminScreen');
                    } else {
                        initEmployee();
                        showScreen('employeeScreen');
                    }
                }
            }
        };
        
        // ========== FUNCIONES DE EXPORTAR A EXCEL ==========
        function exportToExcel(data, filename) {
            // Crear contenido CSV con BOM para UTF-8
            let csv = '\uFEFF';
            
            // Headers
            csv += data.headers.join(',') + '\n';
            
            // Rows
            data.rows.forEach(row => {
                csv += row.map(cell => {
                    // Escapar comillas y envolver en comillas si contiene comas
                    const str = String(cell).replace(/"/g, '""');
                    return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
                }).join(',') + '\n';
            });
            
            // Crear blob y descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.csv';
            link.click();
            URL.revokeObjectURL(link.href);
            notify('âœ… Archivo exportado correctamente');
        }
        
        // Exportar historial del empleado
        function exportEmployeeExcel() {
            const [year, month] = document.getElementById('historyMonth').value.split('-').map(Number);
            const cfg = currentUser.config;
            const records = getRecords();
            const days = new Date(year, month+1, 0).getDate();
            const today = new Date();
            
            const data = {
                headers: ['Fecha', 'DÃ­a', 'Entrada', 'Salida', 'Horas Trabajadas', 'Horario Esperado', 'Estado', 'Puntualidad', 'Minutos Tarde', 'Detalle'],
                rows: []
            };
            
            for(let day=1; day<=days; day++) {
                const date = new Date(year, month, day);
                if(date > today) continue;
                const dow = date.getDay();
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                const key = `${currentUser.username}_${dateKey}`;
                const rec = records[key];
                const isWork = cfg.workDays.includes(dow);
                
                let entry='-', exit='-', hours='-', status='', punctuality='-', lateMinutes=0, detail='-';
                const scheduleEntry = cfg.scheduleEntry || '08:00';
                const scheduleExit = cfg.scheduleExit || '17:00';
                
                if(!isWork && !rec) { status='Descanso'; }
                else if(rec) {
                    if(rec.noWork) { 
                        status = rec.noWorkType;
                        detail = rec.noWorkDetail || '-';
                    } else {
                        entry = rec.entryTime || '-';
                        exit = rec.exitTime || '-';
                        
                        if(rec.entryTime) {
                            const tardiness = checkTardiness(rec.entryTime, scheduleEntry, cfg.tolerance || 15);
                            punctuality = tardiness.late ? 'TARDE' : 'Puntual';
                            lateMinutes = tardiness.minutes;
                        }
                        
                        if(rec.entryTime && rec.exitTime) {
                            const [eH,eM] = rec.entryTime.split(':').map(Number);
                            const [xH,xM] = rec.exitTime.split(':').map(Number);
                            const hoursWorked = (xH+xM/60)-(eH+eM/60);
                            hours = hoursWorked.toFixed(2);
                            status = 'Completado';
                        } else { 
                            status = 'Incompleto'; 
                        }
                    }
                } else if(isWork) { 
                    status = 'Falta'; 
                }
                
                data.rows.push([
                    `${day}/${month+1}/${year}`,
                    getDayName(dow),
                    entry,
                    exit,
                    hours,
                    `${scheduleEntry} - ${scheduleExit}`,
                    status,
                    punctuality,
                    lateMinutes,
                    detail
                ]);
            }
            
            const monthName = getMonthName(month);
            exportToExcel(data, `Asistencia_${currentUser.fullName}_${monthName}_${year}`);
        }
        
        // Exportar historial del admin
        function exportAdminExcel() {
            const empFilter = document.getElementById('adminEmpFilter').value;
            const [year, month] = document.getElementById('adminMonthFilter').value.split('-').map(Number);
            const emps = getEmployees();
            const records = getRecords();
            const days = new Date(year, month+1, 0).getDate();
            const today = new Date();
            
            const data = {
                headers: ['Empleado', 'Usuario', 'Fecha', 'DÃ­a', 'Entrada', 'Salida', 'Horas Trabajadas', 'Horario Esperado', 'Estado', 'Puntualidad', 'Minutos Tarde', 'Detalle'],
                rows: []
            };
            
            const filteredEmps = empFilter === 'all' ? emps : emps.filter(e => e.username === empFilter);
            
            filteredEmps.forEach(emp => {
                const cfg = emp.config;
                for(let day=1; day<=days; day++) {
                    const date = new Date(year, month, day);
                    if(date > today) continue;
                    const dow = date.getDay();
                    const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                    const key = `${emp.username}_${dateKey}`;
                    const rec = records[key];
                    const isWork = cfg.workDays.includes(dow);
                    
                    let entry='-', exit='-', hours='-', status='', punctuality='-', lateMinutes=0, detail='-';
                    const scheduleEntry = cfg.scheduleEntry || '08:00';
                    const scheduleExit = cfg.scheduleExit || '17:00';
                    
                    if(!isWork && !rec) { status='Descanso'; }
                    else if(rec) {
                        if(rec.noWork) { 
                            status = rec.noWorkType;
                            detail = rec.noWorkDetail || '-';
                        } else {
                            entry = rec.entryTime || '-';
                            exit = rec.exitTime || '-';
                            
                            if(rec.entryTime) {
                                const tardiness = checkTardiness(rec.entryTime, scheduleEntry, cfg.tolerance || 15);
                                punctuality = tardiness.late ? 'TARDE' : 'Puntual';
                                lateMinutes = tardiness.minutes;
                            }
                            
                            if(rec.entryTime && rec.exitTime) {
                                const [eH,eM] = rec.entryTime.split(':').map(Number);
                                const [xH,xM] = rec.exitTime.split(':').map(Number);
                                const hoursWorked = (xH+xM/60)-(eH+eM/60);
                                hours = hoursWorked.toFixed(2);
                                status = 'Completado';
                            } else { 
                                status = 'Incompleto'; 
                            }
                        }
                    } else if(isWork) { 
                        status = 'Falta'; 
                    }
                    
                    if(status) {
                        data.rows.push([
                            emp.fullName,
                            emp.username,
                            `${day}/${month+1}/${year}`,
                            getDayName(dow),
                            entry,
                            exit,
                            hours,
                            `${scheduleEntry} - ${scheduleExit}`,
                            status,
                            punctuality,
                            lateMinutes,
                            detail
                        ]);
                    }
                }
            });
            
            const monthName = getMonthName(month);
            const empName = empFilter === 'all' ? 'Todos' : filteredEmps[0]?.fullName || 'Empleado';
            exportToExcel(data, `Asistencia_${empName}_${monthName}_${year}`);
        }
    </script>
</body>
</html>
